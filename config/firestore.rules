rules_version = '2';

// ============================================================================
// Firestore Security Rules - Multi-Platform Support
// ============================================================================
// These rules are designed to work across all supported platforms:
// - Android (mobile)
// - iOS (mobile) 
// - macOS (desktop)
// - Web (browser)
// - Windows (desktop)
//
// Key Features:
// - Platform-agnostic authentication checks
// - Cross-platform user role management
// - Consistent data validation across platforms
// - Secure multi-tenant access patterns
//
// Authentication Methods Supported:
// - Phone OTP (all platforms)
// - Google Sign-In (all platforms)
// - Email/Password (if enabled)
//
// User Roles:
// - admin: Full system access
// - owner: Property management access
// - guest: Booking and profile access
// ============================================================================

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions - Cross-platform compatible
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isGuest(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }
    
    // Draft/publish helpers
    function isDraftDoc() {
      return resource.data.isDraft == true;
    }
    function isDraftIncoming() {
      return request.resource.data.isDraft == true;
    }
    function isPublishedDoc() {
      return resource.data.isDraft == false;
    }
    
    // Platform-agnostic helper functions
    function isAdmin() {
      return isAuthenticated() && getUserRole() == 'admin';
    }
    
    function isOwnerRole() {
      return isAuthenticated() && getUserRole() == 'owner';
    }
    
    function isGuestRole() {
      return isAuthenticated() && getUserRole() == 'guest';
    }
    
    // Multi-platform user validation
    function isValidUser() {
      return isAuthenticated() && request.auth.uid != null && request.auth.uid != '';
    }
    
    // Cross-platform data validation
    // Ensure the provided 'data' contains all 'requiredFields'
    function hasRequiredFields(data, requiredFields) {
      return data.keys().hasAll(requiredFields);
    }
    
    // Users Collection - Cross-platform user management
    match /users/{userId} {
      // Allow listing users for authenticated users (needed for dashboard)
      allow list: if isValidUser();
      
      // Allow reading specific user - Cross-platform compatible
      allow get: if isValidUser() && (
        request.auth.uid == userId ||  // User can read their own profile
        isAdmin() ||                   // Admins can read all profiles
        isOwnerRole()                  // Owners can read guest profiles
      );
      
      // Allow creating user profile - Must be authenticated and own the profile
      allow create: if isValidUser() && 
                       request.auth.uid == userId &&
                       hasRequiredFields(request.resource.data, ['userId', 'role']);
      
      // Allow updating user profile - Cross-platform compatible
      allow update: if isValidUser() && (
        request.auth.uid == userId ||   // User can update their own profile
        isAdmin() ||                    // Admins can update profiles
        (isOwnerRole() && resource.data.role == 'guest') // Owners can update guests
      );
      
      // Allow deleting user profile - Admin/Owner only
      allow delete: if isValidUser() && (
        isAdmin() ||                    // Admins can delete
        (isOwnerRole() && resource.data.role == 'guest') // Owners can delete guests
      );
    }
    
    // PG Properties - Cross-platform property management
    match /pg_properties/{propertyId} {
      // Allow reading properties for all authenticated users
      allow read: if isValidUser();
      
      // Allow creating properties - Must be authenticated and own the property
      allow create: if isValidUser() && 
                       request.resource.data.ownerId == request.auth.uid &&
                       hasRequiredFields(request.resource.data, ['ownerId', 'name']);
      
      // Allow updating/deleting properties - Only property owner or admin
      allow update, delete: if isValidUser() && (
        resource.data.ownerId == request.auth.uid ||  // Property owner
        isAdmin()                                      // Admin can manage all properties
      );
    }
    
    // PGs Collection (alternative name for properties) - Cross-platform compatible
    match /pgs/{pgId} {
      // List: Allow all authenticated users to list (we filter drafts in app code)
      // This is needed because Firestore rules can't filter on list queries
      allow list: if isValidUser();
      
      // Get: Only published PGs or owner/admin can read drafts
      allow get: if isValidUser() && (
        resource.data.isDraft != true ||
        resource.data.ownerUid == request.auth.uid ||
        isAdmin()
      );

      // Creates:
      // - Owner can create PGs.
      // - If creating a draft (isDraft == true), only ownerUid is required.
      // - If creating a published PG (isDraft != true), require 'name' as well.
      allow create: if isValidUser() &&
                       request.resource.data.ownerUid == request.auth.uid &&
                       (
                         (isDraftIncoming() && hasRequiredFields(request.resource.data, ['ownerUid'])) ||
                         (!isDraftIncoming() && hasRequiredFields(request.resource.data, ['ownerUid', 'name']))
                       );

      // Updates:
      // - Owner/admin can update PGs.
      // - Owners can iterate on drafts freely and later publish by setting isDraft to false.
      allow update: if isValidUser() && (
        resource.data.ownerUid == request.auth.uid ||
        isAdmin()
      );

      // Deletes:
      // - Owner/admin only
      allow delete: if isValidUser() && (
        resource.data.ownerUid == request.auth.uid ||
        isAdmin()
      );
    }
    
    // Rooms - Owners can manage rooms in their properties
    match /rooms/{roomId} {
      allow read: if isAuthenticated();
      
      allow create: if isAuthenticated() && 
                       exists(/databases/$(database)/documents/pg_properties/$(request.resource.data.propertyId)) &&
                       get(/databases/$(database)/documents/pg_properties/$(request.resource.data.propertyId)).data.ownerId == request.auth.uid;
      
      allow update, delete: if isAuthenticated() && 
                               exists(/databases/$(database)/documents/pg_properties/$(resource.data.propertyId)) &&
                               get(/databases/$(database)/documents/pg_properties/$(resource.data.propertyId)).data.ownerId == request.auth.uid;
    }
    
    // Bookings - Cross-platform booking management
    match /bookings/{bookingId} {
      // Allow listing bookings for authenticated users (needed for filtering)
      allow list: if isValidUser();
      
      // Allow reading specific booking - Cross-platform compatible
      allow get: if isValidUser() && (
        resource.data.guestId == request.auth.uid ||  // Guest can read their bookings
        resource.data.ownerId == request.auth.uid ||  // Owner can read bookings for their properties
        isAdmin()                                     // Admin can read all bookings
      );
      
      // Allow creating bookings - Must be authenticated guest
      allow create: if isValidUser() && 
                       request.resource.data.guestId == request.auth.uid &&
                       hasRequiredFields(request.resource.data, ['guestId', 'pgId', 'roomId']);
      
      // Allow updating bookings - Guest, owner, or admin
      allow update: if isValidUser() && (
        resource.data.guestId == request.auth.uid ||  // Guest can update their bookings
        resource.data.ownerId == request.auth.uid ||  // Owner can update bookings
        isAdmin()                                     // Admin can update all bookings
      );
      
      // Allow deleting bookings - Admin only for safety
      allow delete: if isValidUser() && isAdmin();
    }
    
    // Payments - Users can read their own payments, owners can list all for dashboard
    match /payments/{paymentId} {
      // Allow listing payments for owners (for dashboard overview)
      allow list: if isAuthenticated();
      
      // Allow reading specific payment if user is involved
      allow get: if isAuthenticated() && (
        resource.data.guestId == request.auth.uid ||  // Guest can read their payments
        resource.data.ownerId == request.auth.uid     // Owner can read payments
      );
      
      allow create: if isAuthenticated();
      
      allow update: if isAuthenticated() && (
        resource.data.guestId == request.auth.uid ||
        resource.data.ownerId == request.auth.uid
      );
      
      allow delete: if isAuthenticated() && getUserRole() == 'admin';
    }
    
    // Complaints - Users can manage their own complaints
    match /complaints/{complaintId} {
      // Allow listing complaints for owners (needed for dashboard)
      allow list: if isAuthenticated();
      
      // Allow reading specific complaint
      allow get: if isAuthenticated() && (
        resource.data.guestId == request.auth.uid ||  // Guest can read their complaints
        resource.data.ownerId == request.auth.uid ||  // Owner can read complaints
        getUserRole() == 'admin'
      );
      
      allow create: if isAuthenticated() && 
                       request.resource.data.guestId == request.auth.uid;
      
      allow update: if isAuthenticated() && (
        resource.data.guestId == request.auth.uid ||
        resource.data.ownerId == request.auth.uid ||
        getUserRole() == 'admin'
      );
      
      allow delete: if isAuthenticated() && getUserRole() == 'admin';
    }
    
    // Reviews - Guests can create reviews, everyone can read
    match /reviews/{reviewId} {
      allow read: if isAuthenticated();
      
      allow create: if isAuthenticated() && 
                       request.resource.data.guestId == request.auth.uid;
      
      allow update, delete: if isAuthenticated() && 
                               resource.data.guestId == request.auth.uid;
    }
    
    // Menus - Owners can manage menus for their properties
    match /weekly_menus/{menuId} {
      allow read: if isAuthenticated();
      
      allow create: if isAuthenticated() && 
                       exists(/databases/$(database)/documents/pg_properties/$(request.resource.data.propertyId)) &&
                       get(/databases/$(database)/documents/pg_properties/$(request.resource.data.propertyId)).data.ownerId == request.auth.uid;
      
      allow update, delete: if isAuthenticated() && 
                               exists(/databases/$(database)/documents/pg_properties/$(resource.data.propertyId)) &&
                               get(/databases/$(database)/documents/pg_properties/$(resource.data.propertyId)).data.ownerId == request.auth.uid;
    }
    
    match /menu_overrides/{overrideId} {
      allow read: if isAuthenticated();
      
      allow create: if isAuthenticated() && 
                       exists(/databases/$(database)/documents/pg_properties/$(request.resource.data.propertyId)) &&
                       get(/databases/$(database)/documents/pg_properties/$(request.resource.data.propertyId)).data.ownerId == request.auth.uid;
      
      allow update, delete: if isAuthenticated() && 
                               exists(/databases/$(database)/documents/pg_properties/$(resource.data.propertyId)) &&
                               get(/databases/$(database)/documents/pg_properties/$(resource.data.propertyId)).data.ownerId == request.auth.uid;
    }
    
    // Owner Food Menus - Owners can manage their own food menus
    match /owner_weekly_menus/{menuId} {
      allow read: if isAuthenticated();
      allow list: if isAuthenticated();
      
      allow create: if isAuthenticated() && 
                       request.resource.data.ownerId == request.auth.uid;
      
      allow update, delete: if isAuthenticated() && 
                               resource.data.ownerId == request.auth.uid;
    }
    
    match /owner_daily_overrides/{overrideId} {
      allow read: if isAuthenticated();
      allow list: if isAuthenticated();
      
      allow create: if isAuthenticated() && 
                       request.resource.data.ownerId == request.auth.uid;
      
      allow update, delete: if isAuthenticated() && 
                               resource.data.ownerId == request.auth.uid;
    }
    
    // Notifications - Users can read their own notifications
    match /notifications/{notificationId} {
      allow read: if isAuthenticated() && 
                     resource.data.userId == request.auth.uid;
      
      allow create: if isAuthenticated();
      
      allow update: if isAuthenticated() && 
                       resource.data.userId == request.auth.uid;
      
      allow delete: if isAuthenticated() && 
                       resource.data.userId == request.auth.uid;
    }
    
    // Emergency Contacts - Users can manage their own emergency contacts
    match /emergency_contacts/{contactId} {
      allow read, write: if isAuthenticated() && 
                            resource.data.userId == request.auth.uid;
    }
    
    // Visitors - Guests and owners can manage visitor records
    match /visitors/{visitorId} {
      allow read: if isAuthenticated() && (
        resource.data.guestId == request.auth.uid ||
        resource.data.ownerId == request.auth.uid
      );
      
      allow create: if isAuthenticated() && 
                       request.resource.data.guestId == request.auth.uid;
      
      allow update: if isAuthenticated() && (
        resource.data.guestId == request.auth.uid ||
        resource.data.ownerId == request.auth.uid
      );
      
      allow delete: if isAuthenticated() && 
                       resource.data.guestId == request.auth.uid;
    }
    
    // Payment Notifications - Guest creates, Owner confirms/rejects
    match /payment_notifications/{notificationId} {
      allow read: if isAuthenticated() && (
        resource.data.guestId == request.auth.uid ||
        resource.data.ownerId == request.auth.uid
      );
      allow create: if isAuthenticated() && 
                       request.resource.data.guestId == request.auth.uid;
      allow update: if isAuthenticated() && 
                       resource.data.ownerId == request.auth.uid;
      allow delete: if isAuthenticated() && getUserRole() == 'admin';
      allow list: if isAuthenticated();
    }

    // Owner Payment Details - Only owner can manage their own payment details
    match /owner_payment_details/{ownerId} {
      allow read: if isAuthenticated(); // All authenticated users can see payment details
      allow write: if isAuthenticated() && request.auth.uid == ownerId;
    }

    // Revenue Projections - Owner's analytics data
    match /revenue_projections/{projectionId} {
      allow read: if isAuthenticated() && resource.data.ownerId == request.auth.uid;
      allow write: if isAuthenticated() && request.resource.data.ownerId == request.auth.uid;
    }

    // Occupancy Trends - Owner's analytics data
    match /occupancy_trends/{trendId} {
      allow read: if isAuthenticated() && resource.data.ownerId == request.auth.uid;
      allow write: if isAuthenticated() && request.resource.data.ownerId == request.auth.uid;
    }

    // Maintenance Tasks - Owner's maintenance schedule
    match /maintenance_tasks/{taskId} {
      allow read: if isAuthenticated() && resource.data.ownerId == request.auth.uid;
      allow write: if isAuthenticated() && request.resource.data.ownerId == request.auth.uid;
      allow list: if isAuthenticated();
    }

    // Owner Documents - Secure document storage
    match /owner_documents/{documentId} {
      allow read: if isAuthenticated() && resource.data.ownerId == request.auth.uid;
      allow write: if isAuthenticated() && request.resource.data.ownerId == request.auth.uid;
      allow list: if isAuthenticated();
    }

    // Notification Preferences - User's notification settings
    match /notification_preferences/{userId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
    }

    // Owner Subscriptions - Owner subscription management
    match /owner_subscriptions/{subscriptionId} {
      allow read: if isAuthenticated() && (
        resource.data.ownerId == request.auth.uid ||
        isAdmin()
      );
      allow list: if isAuthenticated();
      allow create: if isAuthenticated() && 
                       request.resource.data.ownerId == request.auth.uid;
      allow update: if isAuthenticated() && (
        resource.data.ownerId == request.auth.uid ||
        isAdmin()
      );
      allow delete: if isAuthenticated() && isAdmin();
    }

    // Featured Listings - Featured PG listings
    match /featured_listings/{featuredListingId} {
      allow read: if isAuthenticated(); // All authenticated users can read (for guest app)
      allow list: if isAuthenticated();
      allow create: if isAuthenticated() && 
                       request.resource.data.ownerId == request.auth.uid;
      allow update: if isAuthenticated() && (
        resource.data.ownerId == request.auth.uid ||
        isAdmin()
      );
      allow delete: if isAuthenticated() && (
        resource.data.ownerId == request.auth.uid ||
        isAdmin()
      );
    }

    // Revenue Records - App revenue tracking (admin only)
    match /revenue_records/{revenueId} {
      allow read: if isAuthenticated() && (
        resource.data.ownerId == request.auth.uid ||
        isAdmin()
      );
      allow list: if isAuthenticated() && isAdmin(); // Only admins can list all
      allow create: if isAuthenticated(); // Created by payment service (server-side)
      allow update: if isAuthenticated() && isAdmin(); // Only admins can update
      allow delete: if isAuthenticated() && isAdmin();
    }
    
    // Refund Requests - Owners create, Admins approve/reject/process
    match /refund_requests/{refundRequestId} {
      // Owners can create their own refund requests
      allow create: if isAuthenticated() && 
                       request.resource.data.ownerId == request.auth.uid;
      
      // Owners can read their own refund requests, admins can read all
      allow read: if isAuthenticated() && (
        resource.data.ownerId == request.auth.uid ||
        isAdmin()
      );
      
      // Allow listing: Owners see their own, admins see all
      allow list: if isAuthenticated();
      
      // Only admins can update refund requests (approve/reject/process)
      allow update: if isAuthenticated() && isAdmin();
      
      // No deletions - refund requests are permanent records for audit
      allow delete: if false;
    }
    
    // Owner Guests - Owner can manage guests in their properties
    match /owner_guests/{guestId} {
      allow read: if isAuthenticated() && (
        resource.data.ownerId == request.auth.uid ||
        isAdmin()
      );
      allow create: if isAuthenticated() && 
                       request.resource.data.ownerId == request.auth.uid;
      allow update, delete: if isAuthenticated() && (
        resource.data.ownerId == request.auth.uid ||
        isAdmin()
      );
      allow list: if isAuthenticated();
    }
    
    // Owner Complaints - Owner can manage complaints for their properties
    match /owner_complaints/{complaintId} {
      allow read: if isAuthenticated() && (
        resource.data.ownerId == request.auth.uid ||
        isAdmin()
      );
      allow create: if isAuthenticated() && 
                       request.resource.data.ownerId == request.auth.uid;
      allow update, delete: if isAuthenticated() && (
        resource.data.ownerId == request.auth.uid ||
        isAdmin()
      );
      allow list: if isAuthenticated();
    }
    
    // Owner Bikes - Owner can manage bike registry for their properties
    match /owner_bikes/{bikeId} {
      allow read: if isAuthenticated() && (
        resource.data.ownerId == request.auth.uid ||
        isAdmin()
      );
      allow create: if isAuthenticated() && 
                       request.resource.data.ownerId == request.auth.uid;
      allow update, delete: if isAuthenticated() && (
        resource.data.ownerId == request.auth.uid ||
        isAdmin()
      );
      allow list: if isAuthenticated();
    }
    
    // Owner Services - Owner can manage service requests for their properties
    match /owner_services/{serviceId} {
      allow read: if isAuthenticated() && (
        resource.data.ownerId == request.auth.uid ||
        isAdmin()
      );
      allow create: if isAuthenticated() && 
                       request.resource.data.ownerId == request.auth.uid;
      allow update, delete: if isAuthenticated() && (
        resource.data.ownerId == request.auth.uid ||
        isAdmin()
      );
      allow list: if isAuthenticated();
    }
    
    // Bike Movement Requests - Guests request bike movements, Owners approve/reject
    match /bike_movement_requests/{requestId} {
      allow read: if isAuthenticated() && (
        resource.data.guestId == request.auth.uid ||  // Guest can read their requests
        resource.data.ownerId == request.auth.uid ||  // Owner can read requests for their PGs
        isAdmin()
      );
      allow list: if isAuthenticated();
      allow create: if isAuthenticated() && 
                       request.resource.data.guestId == request.auth.uid;
      allow update: if isAuthenticated() && (
        resource.data.ownerId == request.auth.uid ||  // Owner can approve/reject
        isAdmin()
      );
      allow delete: if isAuthenticated() && isAdmin();
    }
    
    // Owner Booking Requests - Guests create, Owners approve/reject
    match /owner_booking_requests/{requestId} {
      // Allow reading individual documents if user is the guest, owner, or admin
      allow get: if isAuthenticated() && (
        resource.data.guestId == request.auth.uid ||  // Guest can read their requests
        resource.data.ownerId == request.auth.uid ||  // Owner can read requests for their PGs
        isAdmin()
      );
      
      // Allow listing/querying: Any authenticated user can list
      // Firestore will automatically filter results based on the get rule above
      // So guests querying with where('guestId', == uid) will only see their own requests
      // And owners querying with where('ownerId', == uid) will only see their PG requests
      allow list: if isAuthenticated();
      
      allow create: if isAuthenticated() && 
                       request.resource.data.guestId == request.auth.uid;
      allow update: if isAuthenticated() && (
        resource.data.ownerId == request.auth.uid ||  // Owner can approve/reject
        isAdmin()
      );
      allow delete: if isAuthenticated() && isAdmin();
    }
    
    // Bed Change Requests - Guests request, Owners approve/reject
    match /bed_change_requests/{requestId} {
      allow read: if isAuthenticated() && (
        resource.data.guestId == request.auth.uid ||  // Guest can read their requests
        resource.data.ownerId == request.auth.uid ||  // Owner can read requests for their PGs
        isAdmin()
      );
      allow list: if isAuthenticated();
      allow create: if isAuthenticated() && 
                       request.resource.data.guestId == request.auth.uid;
      allow update: if isAuthenticated() && (
        resource.data.ownerId == request.auth.uid ||  // Owner can approve/reject
        isAdmin()
      );
      allow delete: if isAuthenticated() && isAdmin();
    }
    
    // Food Feedback - Guests submit, Owners read aggregated
    match /food_feedback/{feedbackId} {
      allow read: if isAuthenticated(); // Owners can read for analytics
      allow create: if isAuthenticated() && 
                       request.resource.data.guestId == request.auth.uid;
      allow update: if isAuthenticated() && 
                       resource.data.guestId == request.auth.uid;
      allow delete: if isAuthenticated() && (
        resource.data.guestId == request.auth.uid ||
        isAdmin()
      );
      allow list: if isAuthenticated();
    }
    
    // Foods Collection - Guest food menu browsing
    match /foods/{foodId} {
      // Allow all authenticated users to read foods (for guest dashboard)
      allow read: if isAuthenticated();
      allow list: if isAuthenticated();
      
      // Only admins or owners can create/update/delete foods
      allow create: if isAuthenticated() && (
        isAdmin() ||
        isOwnerRole()
      );
      
      allow update: if isAuthenticated() && (
        isAdmin() ||
        isOwnerRole()
      );
      
      allow delete: if isAuthenticated() && isAdmin();
    }
    
    // Guest Booking Requests - Mirror collection for guest's own requests
    match /guest_booking_requests/{requestId} {
      // Allow reading individual documents if user is the guest
      allow get: if isAuthenticated() && 
                   resource.data.guestId == request.auth.uid;
      
      // Allow listing/querying: Guests can query their own requests
      allow list: if isAuthenticated();
      
      // Guests can create their own booking requests
      allow create: if isAuthenticated() && 
                       request.resource.data.guestId == request.auth.uid;
      
      // Guests can update their own requests (but not status after owner responds)
      allow update: if isAuthenticated() && 
                       resource.data.guestId == request.auth.uid;
      
      // Only admins can delete
      allow delete: if isAuthenticated() && isAdmin();
    }
    
    // PG Subcollections - Beds, Rooms, Floors
    // Owners can manage, Guests can read their assigned beds/rooms
    match /pgs/{pgId}/beds/{bedId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && (
        get(/databases/$(database)/documents/pgs/$(pgId)).data.ownerUid == request.auth.uid ||
        isAdmin()
      );
    }
    
    match /pgs/{pgId}/rooms/{roomId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && (
        get(/databases/$(database)/documents/pgs/$(pgId)).data.ownerUid == request.auth.uid ||
        isAdmin()
      );
    }
    
    match /pgs/{pgId}/floors/{floorId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && (
        get(/databases/$(database)/documents/pgs/$(pgId)).data.ownerUid == request.auth.uid ||
        isAdmin()
      );
    }
    
    // Default deny all other access
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

