name: ðŸš€ Production Pipeline - Release Deployment

on:
  push:
    tags:
      - 'v*'  # Triggers on any version tag (v1.0.0, v1.2.3, v1.0.6, etc.)
  workflow_dispatch:
    inputs:
      version_tag:
        description: 'Version tag to deploy (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'
      skip_approval:
        description: 'Skip manual approval (emergency only)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

# Prevent concurrent production deployments
concurrency:
  group: production-deployment
  cancel-in-progress: false

env:
  JAVA_VERSION: '17'
  FLUTTER_VERSION: '3.35.7' # Pinned for reproducibility
  APP_ID: 'com.avishio.atitia'

# Explicit permissions required for tag-triggered workflows
permissions:
  contents: write  # Changed to write for creating releases and updating CHANGELOG
  pull-requests: read
  issues: read

jobs:
  # ============================================================================
  # STAGE 1: Validation & Tag Verification
  # ============================================================================
  
  validate-production:
    name: âœ… Validate Production Deployment
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ” Verify Tag & Branch
        run: |
          echo "ðŸ” Validating production deployment requirements..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            TAG_NAME="${{ github.ref_name }}"
            echo "ðŸ“Œ Version tag detected: $TAG_NAME"
            
            # Verify tag format (semantic versioning)
            if [[ ! "$TAG_NAME" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "âŒ ERROR: Invalid tag format"
              echo "ðŸ’¡ Tag must follow semantic versioning: v1.0.0"
              echo "ðŸ’¡ Current tag: $TAG_NAME"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              exit 1
            fi
            
            # Verify tag is on main branch
            echo "ðŸ” Verifying tag is on main branch..."
            git fetch origin main:main 2>/dev/null || true
            
            if git branch -r --contains "$TAG_NAME" | grep -q "origin/main"; then
              echo "âœ… Tag $TAG_NAME is on main branch"
            else
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "âŒ ERROR: Tag $TAG_NAME is not on main branch"
              echo "ðŸ’¡ Production deployment only allowed from main branch"
              echo "ðŸ’¡ Please ensure tag is created on main branch:"
              echo "   git checkout main"
              echo "   git tag $TAG_NAME"
              echo "   git push origin main --tags"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              exit 1
            fi
            
            # Extract version from tag
            VERSION="${TAG_NAME#v}"
            echo "ðŸ“¦ Version: $VERSION"
          else
            echo "ðŸ“Œ Manual dispatch detected"
            VERSION="${{ github.event.inputs.version_tag }}"
            VERSION="${VERSION#v}"  # Remove 'v' prefix if present
            echo "ðŸ“¦ Version: $VERSION"
          fi
          
          # Export version for use in other steps
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Tag/branch validation complete"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: ðŸ” Verify Version in pubspec.yaml
        run: |
          echo "ðŸ” Verifying version in pubspec.yaml..."
          PUBSPEC_VERSION=$(grep "^version:" pubspec.yaml | sed 's/version: //' | sed 's/+.*//')
          TAG_VERSION="${TAG_VERSION:-${{ github.ref_name }}}"
          
          echo "ðŸ“¦ pubspec.yaml version: $PUBSPEC_VERSION"
          echo "ðŸ“Œ Tag version: ${TAG_VERSION#v}"
          
          # Note: Version should match (warning, not blocking for now)
          echo "âœ… Version check complete"

      - name: ðŸ” Verify Production Secrets
        run: |
          echo "ðŸ” Verifying production deployment secrets..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          MISSING_SECRETS=0
          
          # Check Android secrets
          if [ -z "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" ]; then
            echo "âš ï¸  ANDROID_KEYSTORE_BASE64 not configured"
            MISSING_SECRETS=$((MISSING_SECRETS + 1))
          else
            echo "âœ… Android keystore configured"
          fi
          
          if [ -z "${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" ]; then
            echo "âš ï¸  ANDROID_KEYSTORE_PASSWORD not configured"
            MISSING_SECRETS=$((MISSING_SECRETS + 1))
          else
            echo "âœ… Android keystore password configured"
          fi
          
          # Check iOS secrets (optional - iOS deployment will skip if not configured)
          if [ -z "${{ secrets.IOS_CERTIFICATE_BASE64 }}" ]; then
            echo "âš ï¸  iOS certificate not configured (iOS deployment will be skipped)"
          else
            echo "âœ… iOS certificate configured"
          fi
          
          # Check store publishing secrets
          if [ -z "${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}" ]; then
            echo "âš ï¸  GOOGLE_PLAY_SERVICE_ACCOUNT_JSON not configured (Play Store upload will be skipped)"
          else
            echo "âœ… Google Play service account configured"
          fi
          
          # Check Firebase production secrets
          if [ -z "${{ secrets.FIREBASE_SERVICE_ACCOUNT }}" ]; then
            echo "âš ï¸  FIREBASE_SERVICE_ACCOUNT not configured (Firebase deployment will be skipped)"
          else
            echo "âœ… Firebase service account configured"
          fi
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          if [ $MISSING_SECRETS -gt 0 ]; then
            echo "âš ï¸  Warning: $MISSING_SECRETS required secret(s) missing"
            echo "ðŸ’¡ Some deployments may be skipped"
          else
            echo "âœ… All required secrets configured"
          fi

  # ============================================================================
  # STAGE 2: Manual Approval Gate (Production Safety)
  # ============================================================================
  
  # Note: Manual approval is handled via GitHub Environments
  # Create a "production" environment in GitHub settings with required reviewers
  
  production-approval:
    name: ðŸ‘¤ Manual Approval (Production Release)
    runs-on: ubuntu-latest
    needs: validate-production
    if: github.event.inputs.skip_approval != 'true'
    environment:
      name: production
      url: https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name || github.event.inputs.version_tag }}
    steps:
      - name: âœ… Production Release Approved
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… PRODUCTION RELEASE APPROVED"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ðŸ“¦ Version: ${{ github.ref_name || github.event.inputs.version_tag }}"
          echo "ðŸ‘¤ Approved by: ${{ github.actor }}"
          echo "ðŸ• Approved at: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          echo "ðŸš€ Proceeding with production deployment..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  # ============================================================================
  # STAGE 3: Quality Gates (Reuse from Staging - Proven to Work)
  # ============================================================================
  
  entry-gate:
    name: ðŸšª Entry Gate
    runs-on: ubuntu-latest
    timeout-minutes: 2
    needs: [validate-production, production-approval]
    if: always() && needs.validate-production.result == 'success' && (github.event.inputs.skip_approval == 'true' || needs.production-approval.result == 'success' || needs.production-approval.result == 'skipped')
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: âœ… Validate Project Structure
        run: |
          echo "ðŸ” Validating project structure..."
          [ -f "pubspec.yaml" ] || { echo "âŒ pubspec.yaml not found"; exit 1; }
          [ -d "lib" ] || { echo "âŒ lib/ directory not found"; exit 1; }
          [ -d "android" ] || { echo "âŒ android/ directory not found"; exit 1; }
          [ -d "ios" ] || { echo "âŒ ios/ directory not found"; exit 1; }
          echo "âœ… Project structure valid"

      - name: ðŸ”’ Security Pre-Check
        run: |
          echo "ðŸ”’ Running security pre-check..."
          if grep -rE "(password|secret|api_key|private_key|token)" lib/ --include="*.dart" 2>/dev/null | grep -vE "(TODO|FIXME|example|test)" | grep -vE "^[[:space:]]*//"; then
            echo "âš ï¸ Potential secrets found - please review"
          else
            echo "âœ… No obvious secrets detected"
          fi
        continue-on-error: true

  dependencies:
    name: ðŸ“¦ Resolve Dependencies
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: entry-gate
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸŽ¯ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: ðŸ“¦ Get Dependencies
        run: |
          set +e
          echo "ðŸ“¦ Resolving dependencies..."
          flutter pub get --no-example
          PUB_GET_EXIT=$?
          
          if [ "$PUB_GET_EXIT" -ne 0 ]; then
            echo "âš ï¸ First attempt failed, retrying..."
            flutter pub get --verbose 2>&1 | tail -50
            RETRY_EXIT=$?
            
            if [ "$RETRY_EXIT" -ne 0 ]; then
              echo "âŒ Dependency resolution failed"
              exit 1
            fi
          fi
          
          echo "âœ… Dependencies resolved successfully"
        timeout-minutes: 10

  code-quality:
    name: ðŸ“Š Code Quality
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: dependencies
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸŽ¯ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: ðŸ’¾ Cache Flutter Pub Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.PUB_CACHE }}
            .dart_tool
            .packages
            pubspec.lock
          key: ${{ runner.os }}-pub-${{ hashFiles('pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-

      - name: ðŸ“¦ Get Dependencies
        run: flutter pub get
        timeout-minutes: 3

      - name: ðŸ” Static Analysis
        run: |
          set +e
          echo "ðŸ” Running static analysis..."
          
          ANALYSIS_OUTPUT=$(flutter analyze --no-fatal-infos --no-fatal-warnings 2>&1)
          ANALYSIS_EXIT_CODE=$?
          
          if echo "$ANALYSIS_OUTPUT" | grep -q "error â€¢" 2>/dev/null; then
            echo "âŒ Code analysis found ERRORS (blocking):"
            echo "$ANALYSIS_OUTPUT" | grep "error â€¢" | head -30
            exit 1
          fi
          
          echo "âœ… Code analysis complete"
        timeout-minutes: 10

      - name: ðŸ“ Format Check
        run: |
          set +e
          echo "ðŸ“ Checking code formatting..."
          
          FORMAT_OUTPUT=$(dart format --set-exit-if-changed . 2>&1)
          FORMAT_EXIT_CODE=$?
          
          CHANGED_COUNT=$(echo "$FORMAT_OUTPUT" | grep -oE "\([0-9]+ changed\)" 2>/dev/null | grep -oE "[0-9]+" 2>/dev/null || echo "")
          
          if [ -n "$CHANGED_COUNT" ] && [ "$CHANGED_COUNT" -ne 0 ]; then
            echo "âŒ Formatting issues detected (blocking)"
            echo "ðŸ“Š Files needing formatting: $CHANGED_COUNT"
            echo "ðŸ’¡ Run: dart format ."
            exit 1
          fi
          
          echo "âœ… Code properly formatted"
        timeout-minutes: 5

  security-audit:
    name: ðŸ”’ Security Audit
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: dependencies
    if: "!failure() && !cancelled()"
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸŽ¯ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: ðŸ“¦ Get Dependencies
        run: flutter pub get
        timeout-minutes: 3

      - name: ðŸ”’ Security Audit
        run: |
          set +e
          echo "ðŸ”’ Running security audit..."
          
          AUDIT_OUTPUT=$(flutter pub audit 2>&1)
          AUDIT_EXIT_CODE=$?
          
          if echo "$AUDIT_OUTPUT" | grep -qiE "(critical|high severity)" 2>/dev/null; then
            echo "âŒ CRITICAL/HIGH severity vulnerabilities found (blocking):"
            echo "$AUDIT_OUTPUT" | grep -iE "(critical|high severity)" || echo "$AUDIT_OUTPUT"
            exit 1
          fi
          
          echo "âœ… Security audit passed - no critical vulnerabilities"
        timeout-minutes: 10

  test:
    name: ðŸ§ª Run Tests
    runs-on: ubuntu-latest
    timeout-minutes: 25
    needs: dependencies
    if: "!failure() && !cancelled()"
    
    strategy:
      fail-fast: false
      matrix:
        test-type: [unit, widget, integration]
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸŽ¯ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: ðŸ“¦ Get Dependencies
        run: flutter pub get
        timeout-minutes: 3

      - name: ðŸ§ª Run Unit Tests
        if: matrix.test-type == 'unit'
        run: |
          echo "ðŸ§ª Running unit tests..."
          flutter test test/unit/ --no-pub --coverage
        timeout-minutes: 12

      - name: ðŸŽ¨ Run Widget Tests
        if: matrix.test-type == 'widget'
        run: |
          echo "ðŸŽ¨ Running widget tests..."
          flutter test test/widget_test.dart --no-pub --coverage
        timeout-minutes: 8

      - name: ðŸ”— Run Integration Tests
        if: matrix.test-type == 'integration'
        run: |
          echo "ðŸ”— Running integration tests..."
          if [ -d "test/integration" ] && [ "$(ls -A test/integration/*.dart 2>/dev/null)" ]; then
            flutter test test/integration/ --no-pub --coverage
          else
            echo "â„¹ï¸ No integration tests found, skipping..."
          fi
        continue-on-error: true
        timeout-minutes: 15

  # ============================================================================
  # STAGE 3.5: Verify Deployment Secrets
  # ============================================================================
  
  verify-deployment-secrets:
    name: ðŸ” Verify Deployment Secrets
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: [test, code-quality, security-audit, entry-gate]
    if: "!failure() && !cancelled()"
    
    outputs:
      android_deploy_enabled: ${{ steps.check-secrets.outputs.android_deploy_enabled }}
      ios_deploy_enabled: ${{ steps.check-secrets.outputs.ios_deploy_enabled }}
      web_deploy_enabled: ${{ steps.check-secrets.outputs.web_deploy_enabled }}
    
    steps:
      - name: ðŸ” Check Deployment Secrets
        id: check-secrets
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ” VERIFYING DEPLOYMENT SECRETS"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ðŸ” Debug: Checking secrets access..."
          echo "   Workflow: ${{ github.workflow }}"
          echo "   Event: ${{ github.event_name }}"
          echo "   Ref: ${{ github.ref }}"
          echo "   Repository: ${{ github.repository }}"
          echo ""
          
          # Initialize counters
          ANDROID_COUNT=0
          ANDROID_REQUIRED=5
          IOS_COUNT=0
          IOS_REQUIRED=6
          WEB_COUNT=0
          WEB_REQUIRED=2
          
          # Check Android secrets
          echo "ðŸ¤– Checking Android secrets ($ANDROID_REQUIRED required)..."
          
          # Use length check to avoid multiline JSON issues with [ -n ] test
          SECRET_LEN=$(printf '%s' "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | wc -c | tr -d ' ')
          if [ "$SECRET_LEN" -gt 0 ] 2>/dev/null; then
            ANDROID_COUNT=$((ANDROID_COUNT + 1))
            echo "  âœ… ANDROID_KEYSTORE_BASE64 (length: $SECRET_LEN chars)"
          else
            echo "  âŒ ANDROID_KEYSTORE_BASE64 (not found or empty)"
          fi
          
          SECRET_LEN=$(printf '%s' "${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" | wc -c | tr -d ' ')
          if [ "$SECRET_LEN" -gt 0 ] 2>/dev/null; then
            ANDROID_COUNT=$((ANDROID_COUNT + 1))
            echo "  âœ… ANDROID_KEYSTORE_PASSWORD (length: $SECRET_LEN chars)"
          else
            echo "  âŒ ANDROID_KEYSTORE_PASSWORD (not found or empty)"
          fi
          
          SECRET_LEN=$(printf '%s' "${{ secrets.ANDROID_KEY_ALIAS }}" | wc -c | tr -d ' ')
          if [ "$SECRET_LEN" -gt 0 ] 2>/dev/null; then
            ANDROID_COUNT=$((ANDROID_COUNT + 1))
            echo "  âœ… ANDROID_KEY_ALIAS (length: $SECRET_LEN chars)"
          else
            echo "  âŒ ANDROID_KEY_ALIAS (not found or empty)"
          fi
          
          SECRET_LEN=$(printf '%s' "${{ secrets.ANDROID_KEY_PASSWORD }}" | wc -c | tr -d ' ')
          if [ "$SECRET_LEN" -gt 0 ] 2>/dev/null; then
            ANDROID_COUNT=$((ANDROID_COUNT + 1))
            echo "  âœ… ANDROID_KEY_PASSWORD (length: $SECRET_LEN chars)"
          else
            echo "  âŒ ANDROID_KEY_PASSWORD (not found or empty)"
          fi
          
          SECRET_LEN=$(printf '%s' "${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}" | wc -c | tr -d ' ')
          if [ "$SECRET_LEN" -gt 0 ] 2>/dev/null; then
            ANDROID_COUNT=$((ANDROID_COUNT + 1))
            echo "  âœ… GOOGLE_PLAY_SERVICE_ACCOUNT_JSON (length: $SECRET_LEN chars)"
          else
            echo "  âŒ GOOGLE_PLAY_SERVICE_ACCOUNT_JSON (not found or empty)"
          fi
          
          echo "  ðŸ“Š Android: $ANDROID_COUNT/$ANDROID_REQUIRED secrets configured"
          if [ "$ANDROID_COUNT" -lt "$ANDROID_REQUIRED" ]; then
            echo "  âš ï¸  Missing: $((ANDROID_REQUIRED - ANDROID_COUNT)) secret(s)"
          fi
          echo ""
          
          # Check iOS secrets
          echo "ðŸŽ Checking iOS secrets ($IOS_REQUIRED required - optional)..."
          
          SECRET_LEN=$(printf '%s' "${{ secrets.IOS_CERTIFICATE_BASE64 }}" | wc -c | tr -d ' ')
          if [ "$SECRET_LEN" -gt 0 ] 2>/dev/null; then
            IOS_COUNT=$((IOS_COUNT + 1))
            echo "  âœ… IOS_CERTIFICATE_BASE64 (length: $SECRET_LEN chars)"
          else
            echo "  âŒ IOS_CERTIFICATE_BASE64 (not found or empty)"
          fi
          
          SECRET_LEN=$(printf '%s' "${{ secrets.IOS_CERTIFICATE_PASSWORD }}" | wc -c | tr -d ' ')
          if [ "$SECRET_LEN" -gt 0 ] 2>/dev/null; then
            IOS_COUNT=$((IOS_COUNT + 1))
            echo "  âœ… IOS_CERTIFICATE_PASSWORD (length: $SECRET_LEN chars)"
          else
            echo "  âŒ IOS_CERTIFICATE_PASSWORD (not found or empty)"
          fi
          
          SECRET_LEN=$(printf '%s' "${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}" | wc -c | tr -d ' ')
          if [ "$SECRET_LEN" -gt 0 ] 2>/dev/null; then
            IOS_COUNT=$((IOS_COUNT + 1))
            echo "  âœ… IOS_PROVISIONING_PROFILE_BASE64 (length: $SECRET_LEN chars)"
          else
            echo "  âŒ IOS_PROVISIONING_PROFILE_BASE64 (not found or empty)"
          fi
          
          SECRET_LEN=$(printf '%s' "${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}" | wc -c | tr -d ' ')
          if [ "$SECRET_LEN" -gt 0 ] 2>/dev/null; then
            IOS_COUNT=$((IOS_COUNT + 1))
            echo "  âœ… APP_STORE_CONNECT_API_KEY_ID (length: $SECRET_LEN chars)"
          else
            echo "  âŒ APP_STORE_CONNECT_API_KEY_ID (not found or empty)"
          fi
          
          SECRET_LEN=$(printf '%s' "${{ secrets.APP_STORE_CONNECT_API_ISSUER }}" | wc -c | tr -d ' ')
          if [ "$SECRET_LEN" -gt 0 ] 2>/dev/null; then
            IOS_COUNT=$((IOS_COUNT + 1))
            echo "  âœ… APP_STORE_CONNECT_API_ISSUER (length: $SECRET_LEN chars)"
          else
            echo "  âŒ APP_STORE_CONNECT_API_ISSUER (not found or empty)"
          fi
          
          SECRET_LEN=$(printf '%s' "${{ secrets.APP_STORE_CONNECT_API_KEY }}" | wc -c | tr -d ' ')
          if [ "$SECRET_LEN" -gt 0 ] 2>/dev/null; then
            IOS_COUNT=$((IOS_COUNT + 1))
            echo "  âœ… APP_STORE_CONNECT_API_KEY (length: $SECRET_LEN chars)"
          else
            echo "  âŒ APP_STORE_CONNECT_API_KEY (not found or empty)"
          fi
          
          echo "  ðŸ“Š iOS: $IOS_COUNT/$IOS_REQUIRED secrets configured"
          if [ "$IOS_COUNT" -lt "$IOS_REQUIRED" ]; then
            echo "  â„¹ï¸  Missing: $((IOS_REQUIRED - IOS_COUNT)) secret(s) (iOS deployment optional)"
          fi
          echo ""
          
          # Check Web/Firebase secrets
          echo "ðŸŒ Checking Web/Firebase secrets ($WEB_REQUIRED required)..."
          
          SECRET_LEN=$(printf '%s' "${{ secrets.FIREBASE_SERVICE_ACCOUNT }}" | wc -c | tr -d ' ')
          if [ "$SECRET_LEN" -gt 0 ] 2>/dev/null; then
            WEB_COUNT=$((WEB_COUNT + 1))
            echo "  âœ… FIREBASE_SERVICE_ACCOUNT (length: $SECRET_LEN chars)"
          else
            echo "  âŒ FIREBASE_SERVICE_ACCOUNT (not found or empty)"
          fi
          
          SECRET_LEN=$(printf '%s' "${{ secrets.FIREBASE_PROJECT_ID }}" | wc -c | tr -d ' ')
          if [ "$SECRET_LEN" -gt 0 ] 2>/dev/null; then
            WEB_COUNT=$((WEB_COUNT + 1))
            echo "  âœ… FIREBASE_PROJECT_ID (length: $SECRET_LEN chars)"
          else
            echo "  âŒ FIREBASE_PROJECT_ID (not found or empty)"
          fi
          
          echo "  ðŸ“Š Web/Firebase: $WEB_COUNT/$WEB_REQUIRED secrets configured"
          if [ "$WEB_COUNT" -lt "$WEB_REQUIRED" ]; then
            echo "  âš ï¸  Missing: $((WEB_REQUIRED - WEB_COUNT)) secret(s)"
          fi
          echo ""
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“Š SECRET VERIFICATION SUMMARY"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          
          # Set outputs based on secret counts
          if [ "$ANDROID_COUNT" -eq "$ANDROID_REQUIRED" ]; then
            echo "android_deploy_enabled=true" >> $GITHUB_OUTPUT
            echo "âœ… Android: $ANDROID_COUNT/$ANDROID_REQUIRED secrets â†’ DEPLOYMENT ENABLED"
          else
            echo "android_deploy_enabled=false" >> $GITHUB_OUTPUT
            echo "â¸ï¸  Android: $ANDROID_COUNT/$ANDROID_REQUIRED secrets â†’ DEPLOYMENT DISABLED"
            echo "   Missing: $((ANDROID_REQUIRED - ANDROID_COUNT)) secret(s)"
            echo "   ðŸ’¡ Verify secrets are added at: https://github.com/${{ github.repository }}/settings/secrets/actions"
          fi
          
          if [ "$IOS_COUNT" -eq "$IOS_REQUIRED" ]; then
            echo "ios_deploy_enabled=true" >> $GITHUB_OUTPUT
            echo "âœ… iOS: $IOS_COUNT/$IOS_REQUIRED secrets â†’ DEPLOYMENT ENABLED"
          else
            echo "ios_deploy_enabled=false" >> $GITHUB_OUTPUT
            echo "â¸ï¸  iOS: $IOS_COUNT/$IOS_REQUIRED secrets â†’ DEPLOYMENT DISABLED"
            echo "   Missing: $((IOS_REQUIRED - IOS_COUNT)) secret(s)"
            echo "   ðŸ’¡ iOS deployment is optional - add secrets when ready"
          fi
          
          if [ "$WEB_COUNT" -eq "$WEB_REQUIRED" ]; then
            echo "web_deploy_enabled=true" >> $GITHUB_OUTPUT
            echo "âœ… Web/Firebase: $WEB_COUNT/$WEB_REQUIRED secrets â†’ DEPLOYMENT ENABLED"
          else
            echo "web_deploy_enabled=false" >> $GITHUB_OUTPUT
            echo "â¸ï¸  Web/Firebase: $WEB_COUNT/$WEB_REQUIRED secrets â†’ DEPLOYMENT DISABLED"
            echo "   Missing: $((WEB_REQUIRED - WEB_COUNT)) secret(s)"
            echo "   ðŸ’¡ Verify secrets are added at: https://github.com/${{ github.repository }}/settings/secrets/actions"
          fi
          
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  # ============================================================================
  # STAGE 4: Production Builds (All Platforms)
  # ============================================================================
  
  build-android-production:
    name: ðŸ¤– Build Android (Production)
    runs-on: ubuntu-latest
    timeout-minutes: 35
    needs: [code-quality, test, entry-gate, verify-deployment-secrets]
    if: "!failure() && !cancelled() && needs.verify-deployment-secrets.outputs.android_deploy_enabled == 'true'"
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - name: ðŸŽ¯ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: ðŸ’¾ Cache Flutter Pub Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.PUB_CACHE }}
            .dart_tool
            .packages
            pubspec.lock
          key: ${{ runner.os }}-pub-${{ hashFiles('pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-

      - name: ðŸ’¾ Cache Gradle
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
            android/.gradle
          key: ${{ runner.os }}-gradle-${{ hashFiles('android/**/*.gradle*') }}
          restore-keys: |
            ${{ runner.os }}-gradle-

      - name: ðŸ“¦ Get Dependencies
        run: flutter pub get
        timeout-minutes: 3

      - name: ðŸ” Setup Android Signing
        env:
          KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          if [ -n "$KEYSTORE_BASE64" ] && [ "$KEYSTORE_BASE64" != "" ]; then
            echo "ðŸ” Configuring Android production signing..."
            
            # Clean and decode base64 keystore (remove any whitespace/newlines)
            echo "$KEYSTORE_BASE64" | tr -d '\n' | tr -d ' ' | base64 -d > android/keystore.jks
            
            # Verify keystore file was created and is not empty
            if [ ! -f "android/keystore.jks" ] || [ ! -s "android/keystore.jks" ]; then
              echo "âŒ ERROR: Failed to create keystore file"
              exit 1
            fi
            
            echo "âœ… Keystore file created ($(du -h android/keystore.jks | cut -f1))"
            
            # Validate keystore integrity using keytool (non-blocking check)
            echo "ðŸ” Validating keystore integrity..."
            if keytool -list -v -keystore android/keystore.jks -storepass "$KEYSTORE_PASSWORD" -alias "$KEY_ALIAS" > /dev/null 2>&1; then
              echo "âœ… Keystore integrity validated successfully"
            else
              echo "âš ï¸  Warning: Keystore validation failed - this might indicate incorrect password or corrupted keystore"
              echo "ðŸ’¡ Continuing with build attempt..."
            fi
            
            # Create key.properties file
            echo "storePassword=$KEYSTORE_PASSWORD" > android/key.properties
            echo "keyPassword=$KEY_PASSWORD" >> android/key.properties
            echo "keyAlias=$KEY_ALIAS" >> android/key.properties
            echo "storeFile=keystore.jks" >> android/key.properties
            
            echo "âœ… Android signing configured"
          else
            echo "âŒ ERROR: Android keystore secret not configured"
            echo "ðŸ’¡ Production build requires ANDROID_KEYSTORE_BASE64 secret"
            exit 1
          fi

      - name: ðŸ§¹ Clean Up Disk Space
        run: |
          echo "ðŸ§¹ Cleaning up disk space before production build..."
          df -h
          
          # Clean any leftover build artifacts
          rm -rf build/app/intermediates || true
          rm -rf build/app/tmp || true
          
          echo "ðŸ“Š Disk space after cleanup:"
          df -h

      - name: ðŸ¤– Build Android App Bundle (AAB)
        run: |
          echo "ðŸ”¨ Building Android App Bundle (AAB) for production..."
          flutter build appbundle --release --no-pub || {
            echo "âŒ Android AAB build failed"
            exit 1
          }
          echo "âœ… Android App Bundle built successfully"

      - name: ðŸ¤– Build Android APK (Split per ABI)
        run: |
          echo "ðŸ”¨ Building Android APK (split per ABI) for production..."
          flutter build apk --release --split-per-abi --no-pub || {
            echo "âš ï¸ Split APK build completed with notes"
            exit 0
          }
          echo "âœ… Android split APKs built successfully"

      - name: ðŸ“¤ Upload Production Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-production-${{ github.ref_name }}
          path: |
            build/app/outputs/bundle/release/*.aab
            build/app/outputs/flutter-apk/*.apk
          retention-days: 90
          if-no-files-found: error

  build-ios-production:
    name: ðŸŽ Build iOS (Production)
    runs-on: macos-15
    timeout-minutes: 60
    needs: [code-quality, test, entry-gate, verify-deployment-secrets]
    if: "!failure() && !cancelled() && needs.verify-deployment-secrets.outputs.ios_deploy_enabled == 'true'"
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸŽ¯ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: ðŸ“¦ Cache CocoaPods
        uses: actions/cache@v4
        id: pod-cache
        with:
          path: |
            ios/Pods
            ~/Library/Caches/CocoaPods
            ~/.cocoapods
          key: ${{ runner.os }}-pods-${{ hashFiles('ios/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-pods-

      - name: ðŸ“¦ Get Dependencies
        run: flutter pub get
        timeout-minutes: 3

      - name: ðŸ“¦ Setup CocoaPods
        run: |
          echo "ðŸ“¦ Setting up CocoaPods..."
          cd ios
          pod install --deployment || pod install || true
          cd ..
          echo "âœ… CocoaPods ready"
        continue-on-error: true
        timeout-minutes: 8

      - name: ðŸŽ Build iOS IPA
        env:
          IOS_CERTIFICATE_BASE64: ${{ secrets.IOS_CERTIFICATE_BASE64 }}
        run: |
          if [ -n "$IOS_CERTIFICATE_BASE64" ] && [ "$IOS_CERTIFICATE_BASE64" != "" ]; then
            echo "ðŸ”¨ Building iOS IPA for production..."
            flutter build ipa --release --no-pub || {
              echo "âŒ iOS IPA build failed"
              exit 1
            }
            echo "âœ… iOS IPA built successfully"
          else
            echo "âš ï¸ iOS certificate not configured - skipping iOS build"
            echo "ðŸ’¡ Add IOS_CERTIFICATE_BASE64 secret to enable iOS deployment"
            exit 0
          fi
        continue-on-error: true

      - name: ðŸ“¤ Upload iOS Artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: ios-production-${{ github.ref_name }}
          path: |
            build/ios/ipa/*.ipa
          retention-days: 90
          if-no-files-found: ignore

  build-web-production:
    name: ðŸŒ Build Web (Production)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [code-quality, test, entry-gate, verify-deployment-secrets]
    if: "!failure() && !cancelled() && needs.verify-deployment-secrets.outputs.web_deploy_enabled == 'true'"
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸŽ¯ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: ðŸ’¾ Cache Flutter Pub Dependencies
        uses: actions/cache@v4
        with:
          path: |
            ${{ env.PUB_CACHE }}
            .dart_tool
            .packages
            pubspec.lock
          key: ${{ runner.os }}-pub-${{ hashFiles('pubspec.lock') }}
          restore-keys: |
            ${{ runner.os }}-pub-

      - name: ðŸ“¦ Get Dependencies
        run: flutter pub get
        timeout-minutes: 3

      - name: ðŸŒ Build Web
        run: |
          echo "ðŸ”¨ Building Web for production..."
          flutter build web --release --no-pub || {
            echo "âŒ Web build failed"
            exit 1
          }
          echo "âœ… Web build completed"

      - name: ðŸ“¤ Upload Web Artifact
        uses: actions/upload-artifact@v4
        with:
          name: web-production-${{ github.ref_name }}
          path: build/web/
          retention-days: 90
          if-no-files-found: error

  # ============================================================================
  # STAGE 5: Production Deployments (Stores + Firebase)
  # ============================================================================
  
  deploy-android-playstore:
    name: ðŸ“± Deploy to Google Play Store
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [build-android-production, verify-deployment-secrets]
    if: success() && !cancelled() && needs.verify-deployment-secrets.outputs.android_deploy_enabled == 'true'
    environment:
      name: production
    steps:
      - name: ðŸ“¥ Download Android Artifacts
        uses: actions/download-artifact@v4
        with:
          name: android-production-${{ github.ref_name }}
          path: build/app/outputs/

      - name: ðŸ“± Upload to Google Play Store
        env:
          GOOGLE_PLAY_SERVICE_ACCOUNT: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
        run: |
          if [ -n "$GOOGLE_PLAY_SERVICE_ACCOUNT" ] && [ "$GOOGLE_PLAY_SERVICE_ACCOUNT" != "" ]; then
            echo "ðŸ“± Uploading to Google Play Store..."
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            # Write service account to file
            echo "$GOOGLE_PLAY_SERVICE_ACCOUNT" > /tmp/google-play-service-account.json
            
            # Install fastlane (if using) or use gcloud
            # For now, skip actual upload (requires fastlane setup)
            echo "âš ï¸ Play Store upload requires fastlane setup"
            echo "ðŸ’¡ AAB file is ready in artifacts for manual upload"
            echo "ðŸ“¦ AAB location: build/app/outputs/bundle/release/"
            
            echo "âœ… Play Store deployment preparation complete"
          else
            echo "âš ï¸ Google Play service account not configured"
            echo "ðŸ’¡ AAB file is ready in artifacts for manual upload"
          fi
        continue-on-error: true

  deploy-ios-appstore:
    name: ðŸŽ Deploy to Apple App Store
    runs-on: macos-15
    timeout-minutes: 30
    needs: [build-ios-production, verify-deployment-secrets]
    if: success() && !cancelled() && needs.verify-deployment-secrets.outputs.ios_deploy_enabled == 'true'
    environment:
      name: production
    steps:
      - name: ðŸ“¥ Download iOS Artifacts
        uses: actions/download-artifact@v4
        with:
          name: ios-production-${{ github.ref_name }}
          path: build/ios/ipa/

      - name: ðŸŽ Upload to App Store Connect
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
        run: |
          if [ -n "$APPLE_ID" ] && [ -n "$APPLE_APP_SPECIFIC_PASSWORD" ]; then
            echo "ðŸŽ Uploading to App Store Connect..."
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            # Install fastlane (if using) or use altool/xcrun
            # For now, skip actual upload (requires fastlane setup)
            echo "âš ï¸ App Store upload requires fastlane setup"
            echo "ðŸ’¡ IPA file is ready in artifacts for manual upload"
            echo "ðŸ“¦ IPA location: build/ios/ipa/"
            
            echo "âœ… App Store deployment preparation complete"
          else
            echo "âš ï¸ Apple credentials not configured"
            echo "ðŸ’¡ IPA file is ready in artifacts for manual upload"
          fi
        continue-on-error: true

  deploy-firebase-production:
    name: ðŸŒ Deploy to Firebase (Production)
    runs-on: ubuntu-latest
    timeout-minutes: 25
    needs: [build-web-production, verify-deployment-secrets]
    if: success() && !cancelled() && needs.verify-deployment-secrets.outputs.web_deploy_enabled == 'true'
    environment:
      name: production
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ“¥ Download Web Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: web-production-${{ github.ref_name }}
          path: build/web/

      - name: ðŸš€ Deploy to Firebase Hosting (Production)
        env:
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
        run: |
          if [ -n "$FIREBASE_SERVICE_ACCOUNT" ] && [ "$FIREBASE_SERVICE_ACCOUNT" != "" ]; then
            echo "ðŸš€ Deploying to Firebase Hosting (Production)..."
            echo "ðŸ“¦ Version: ${{ github.ref_name }}"
            echo "ðŸ”§ Project: ${FIREBASE_PROJECT_ID:-not-set}"
            
            npm install -g firebase-tools
            
            echo "$FIREBASE_SERVICE_ACCOUNT" > /tmp/firebase-service-account.json
            export GOOGLE_APPLICATION_CREDENTIALS=/tmp/firebase-service-account.json
            
            # Verify service account file was created
            if [ ! -f /tmp/firebase-service-account.json ]; then
              echo "âŒ Failed to create service account file"
              exit 1
            fi
            
            # Extract project ID from service account JSON to verify
            SA_PROJECT_ID=$(cat /tmp/firebase-service-account.json | grep -o '"project_id": "[^"]*"' | cut -d'"' -f4 || echo "")
            echo "ðŸ” Service account project_id: ${SA_PROJECT_ID:-not-found}"
            echo "ðŸ” FIREBASE_PROJECT_ID secret: ${FIREBASE_PROJECT_ID:-not-set}"
            
            if [ -n "$FIREBASE_PROJECT_ID" ] && [ "$FIREBASE_PROJECT_ID" != "" ]; then
              # List available projects first to debug
              echo "ðŸ” Checking Firebase project access..."
              firebase projects:list --json 2>&1 | head -20 || echo "âš ï¸ Could not list projects (may require auth)"
              
              echo "ðŸš€ Deploying to Firebase Hosting..."
              firebase deploy --only hosting --project "$FIREBASE_PROJECT_ID" || {
                echo "âŒ Firebase deployment failed"
                echo "ðŸ’¡ Troubleshooting:"
                echo "   1. Verify service account has 'Firebase Hosting Admin' role"
                echo "   2. Check project ID is correct: $FIREBASE_PROJECT_ID"
                echo "   3. Ensure service account has access to project"
                echo "   4. Go to: https://console.cloud.google.com/iam-admin/iam?project=$FIREBASE_PROJECT_ID"
                rm -f /tmp/firebase-service-account.json
                exit 1
              }
              echo "âœ… Successfully deployed to Firebase Hosting (Production)"
              rm -f /tmp/firebase-service-account.json
            else
              echo "âš ï¸ FIREBASE_PROJECT_ID not set - skipping deployment"
              rm -f /tmp/firebase-service-account.json
            fi
          else
            echo "âš ï¸ Firebase service account not configured - skipping deployment"
            echo "ðŸ’¡ Add FIREBASE_SERVICE_ACCOUNT secret to enable deployment"
          fi
        continue-on-error: true

  # ============================================================================
  # STAGE 6: Production Release Summary
  # ============================================================================
  
  production-release-summary:
    name: ðŸ“‹ Production Release Summary
    runs-on: ubuntu-latest
    needs: [validate-production, production-approval, entry-gate, dependencies, code-quality, security-audit, test, verify-deployment-secrets, build-android-production, build-ios-production, build-web-production, deploy-android-playstore, deploy-ios-appstore, deploy-firebase-production]
    if: always()
    
    steps:
      - name: ðŸ“Š Generate Release Summary
        run: |
          echo "## ðŸš€ Production Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Execution Time:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Quality Gates" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Gate | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| âœ… Validation | ${{ needs.validate-production.result }} |" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event.inputs.skip_approval }}" == "true" ]; then
            echo "| ðŸ‘¤ Approval | âš ï¸ Skipped (Emergency) |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.production-approval.result }}" == "success" ]; then
            echo "| ðŸ‘¤ Approval | âœ… Approved |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.production-approval.result }}" == "skipped" ]; then
            echo "| ðŸ‘¤ Approval | â³ Skipped (not required) |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸ‘¤ Approval | â³ Pending |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "| ðŸšª Entry Gate | ${{ needs.entry-gate.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“¦ Dependencies | ${{ needs.dependencies.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“Š Code Quality | ${{ needs.code-quality.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”’ Security | ${{ needs.security-audit.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ§ª Tests | ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### ðŸ” Deployment Secrets Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          if [ "${{ needs.verify-deployment-secrets.outputs.android_deploy_enabled }}" == "true" ]; then
            echo "| ðŸ¤– Android | âœ… Enabled |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸ¤– Android | â¸ï¸ Disabled (missing secrets) |" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ needs.verify-deployment-secrets.outputs.ios_deploy_enabled }}" == "true" ]; then
            echo "| ðŸŽ iOS | âœ… Enabled |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸŽ iOS | â¸ï¸ Disabled (missing secrets) |" >> $GITHUB_STEP_SUMMARY
          fi
          if [ "${{ needs.verify-deployment-secrets.outputs.web_deploy_enabled }}" == "true" ]; then
            echo "| ðŸŒ Web/Firebase | âœ… Enabled |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸŒ Web/Firebase | â¸ï¸ Disabled (missing secrets) |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Production Builds" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Build | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ¤– Android (AAB/APK) | ${{ needs.build-android-production.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŽ iOS (IPA) | ${{ needs.build-ios-production.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŒ Web | ${{ needs.build-web-production.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Production Deployments" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Deployment | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“± Google Play Store | ${{ needs.deploy-android-playstore.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŽ Apple App Store | ${{ needs.deploy-ios-appstore.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŒ Firebase (Production) | ${{ needs.deploy-firebase-production.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Determine overall status
          CRITICAL_JOBS="${{ needs.validate-production.result }} ${{ needs.entry-gate.result }} ${{ needs.dependencies.result }} ${{ needs.code-quality.result }}"
          BUILD_JOBS="${{ needs.build-android-production.result }} ${{ needs.build-web-production.result }}"
          
          if echo "$CRITICAL_JOBS" | grep -q "failure"; then
            echo "### âŒ **Status: PRODUCTION RELEASE FAILED**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Critical quality gates failed. Release cannot proceed." >> $GITHUB_STEP_SUMMARY
          elif echo "$BUILD_JOBS" | grep -q "failure"; then
            echo "### âš ï¸ **Status: PRODUCTION RELEASE PARTIAL**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Some builds failed. Review artifacts and logs." >> $GITHUB_STEP_SUMMARY
          else
            echo "### âœ… **Status: PRODUCTION RELEASE SUCCESSFUL**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All production builds completed successfully. Check deployment status above." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Production Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Android AAB/APK:** Available in artifacts (90-day retention)" >> $GITHUB_STEP_SUMMARY
          echo "- **iOS IPA:** Available in artifacts (90-day retention)" >> $GITHUB_STEP_SUMMARY
          echo "- **Web Build:** Available in artifacts (90-day retention)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Download production artifacts from GitHub Actions" >> $GITHUB_STEP_SUMMARY
          echo "2. Upload to App Store/Play Store (if not automated)" >> $GITHUB_STEP_SUMMARY
          echo "3. Verify Firebase production deployment" >> $GITHUB_STEP_SUMMARY
          echo "4. Monitor app store review process" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Job summary generated at run-time" >> $GITHUB_STEP_SUMMARY

  # ============================================================================
  # STAGE 7: Release Notes Automation & GitHub Release Creation
  # ============================================================================
  
  generate-release-notes:
    name: ðŸŽ¨ Generate Release Notes & Create GitHub Release
    runs-on: ubuntu-latest
    needs: [production-release-summary]
    if: always() && needs.production-release-summary.result != 'cancelled'
    permissions:
      contents: write
      pull-requests: read
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history needed for changelog generation

      - name: ðŸ” Get Previous Tag
        id: previous-tag
        run: |
          TAG_NAME="${{ github.ref_name }}"
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 "$TAG_NAME^" 2>/dev/null || echo "")
          
          if [ -z "$PREVIOUS_TAG" ]; then
            # First release - use first commit
            PREVIOUS_TAG=$(git rev-list --max-parents=0 HEAD)
            echo "â„¹ï¸  No previous tag found, using first commit: $PREVIOUS_TAG"
          else
            echo "ðŸ“Œ Previous tag: $PREVIOUS_TAG"
          fi
          
          echo "previous_tag=$PREVIOUS_TAG" >> $GITHUB_OUTPUT
          echo "current_tag=$TAG_NAME" >> $GITHUB_OUTPUT

      - name: ðŸ“ Generate Release Notes
        id: release-notes
        run: |
          PREV_TAG="${{ steps.previous-tag.outputs.previous_tag }}"
          CURR_TAG="${{ steps.previous-tag.outputs.current_tag }}"
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸŽ¨ GENERATING RELEASE NOTES"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Previous: $PREV_TAG"
          echo "Current:  $CURR_TAG"
          echo ""
          
          # Generate release notes from commits
          RELEASE_NOTES_FILE=$(mktemp)
          
          echo "# Release $CURR_TAG" > "$RELEASE_NOTES_FILE"
          echo "" >> "$RELEASE_NOTES_FILE"
          echo "**Release Date:** $(date -u +'%Y-%m-%d')" >> "$RELEASE_NOTES_FILE"
          echo "**Triggered by:** ${{ github.actor }}" >> "$RELEASE_NOTES_FILE"
          echo "" >> "$RELEASE_NOTES_FILE"
          echo "## ðŸ“‹ Changes" >> "$RELEASE_NOTES_FILE"
          echo "" >> "$RELEASE_NOTES_FILE"
          
          # Categorize commits by type (Conventional Commits format)
          FEATURES=$(git log "$PREV_TAG..$CURR_TAG" --pretty=format:"- %s (%h)" --grep="^feat" || true)
          FIXES=$(git log "$PREV_TAG..$CURR_TAG" --pretty=format:"- %s (%h)" --grep="^fix" || true)
          DOCS=$(git log "$PREV_TAG..$CURR_TAG" --pretty=format:"- %s (%h)" --grep="^docs" || true)
          PERF=$(git log "$PREV_TAG..$CURR_TAG" --pretty=format:"- %s (%h)" --grep="^perf" || true)
          REFACTOR=$(git log "$PREV_TAG..$CURR_TAG" --pretty=format:"- %s (%h)" --grep="^refactor" || true)
          CHORE=$(git log "$PREV_TAG..$CURR_TAG" --pretty=format:"- %s (%h)" --grep="^chore" || true)
          OTHER=$(git log "$PREV_TAG..$CURR_TAG" --pretty=format:"- %s (%h)" --not --grep="^feat\|^fix\|^docs\|^perf\|^refactor\|^chore" || true)
          
          if [ -n "$FEATURES" ]; then
            echo "### âœ¨ Features" >> "$RELEASE_NOTES_FILE"
            echo "" >> "$RELEASE_NOTES_FILE"
            echo "$FEATURES" >> "$RELEASE_NOTES_FILE"
            echo "" >> "$RELEASE_NOTES_FILE"
          fi
          
          if [ -n "$FIXES" ]; then
            echo "### ðŸ› Bug Fixes" >> "$RELEASE_NOTES_FILE"
            echo "" >> "$RELEASE_NOTES_FILE"
            echo "$FIXES" >> "$RELEASE_NOTES_FILE"
            echo "" >> "$RELEASE_NOTES_FILE"
          fi
          
          if [ -n "$PERF" ]; then
            echo "### âš¡ Performance Improvements" >> "$RELEASE_NOTES_FILE"
            echo "" >> "$RELEASE_NOTES_FILE"
            echo "$PERF" >> "$RELEASE_NOTES_FILE"
            echo "" >> "$RELEASE_NOTES_FILE"
          fi
          
          if [ -n "$REFACTOR" ]; then
            echo "### â™»ï¸  Refactoring" >> "$RELEASE_NOTES_FILE"
            echo "" >> "$RELEASE_NOTES_FILE"
            echo "$REFACTOR" >> "$RELEASE_NOTES_FILE"
            echo "" >> "$RELEASE_NOTES_FILE"
          fi
          
          if [ -n "$DOCS" ]; then
            echo "### ðŸ“š Documentation" >> "$RELEASE_NOTES_FILE"
            echo "" >> "$RELEASE_NOTES_FILE"
            echo "$DOCS" >> "$RELEASE_NOTES_FILE"
            echo "" >> "$RELEASE_NOTES_FILE"
          fi
          
          if [ -n "$CHORE" ]; then
            echo "### ðŸ”§ Chores" >> "$RELEASE_NOTES_FILE"
            echo "" >> "$RELEASE_NOTES_FILE"
            echo "$CHORE" >> "$RELEASE_NOTES_FILE"
            echo "" >> "$RELEASE_NOTES_FILE"
          fi
          
          if [ -n "$OTHER" ]; then
            echo "### ðŸ“¦ Other Changes" >> "$RELEASE_NOTES_FILE"
            echo "" >> "$RELEASE_NOTES_FILE"
            echo "$OTHER" | head -20 >> "$RELEASE_NOTES_FILE"
            echo "" >> "$RELEASE_NOTES_FILE"
          fi
          
          # Get commit count
          COMMIT_COUNT=$(git rev-list --count "$PREV_TAG..$CURR_TAG" 2>/dev/null || echo "0")
          echo "" >> "$RELEASE_NOTES_FILE"
          echo "---" >> "$RELEASE_NOTES_FILE"
          echo "" >> "$RELEASE_NOTES_FILE"
          echo "**Total commits:** $COMMIT_COUNT" >> "$RELEASE_NOTES_FILE"
          
          # Save to output
          cat "$RELEASE_NOTES_FILE"
          echo "release_notes<<EOF" >> $GITHUB_OUTPUT
          cat "$RELEASE_NOTES_FILE" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: ðŸ“ Update CHANGELOG.md
        run: |
          TAG_NAME="${{ steps.previous-tag.outputs.current_tag }}"
          VERSION="${TAG_NAME#v}"  # Remove 'v' prefix
          DATE=$(date -u +'%Y-%m-%d')
          
          # Create backup
          cp CHANGELOG.md CHANGELOG.md.bak 2>/dev/null || true
          
          # Read current release notes
          RELEASE_NOTES="${{ steps.release-notes.outputs.release_notes }}"
          
          # Extract changes section (everything after first ##)
          CHANGES_SECTION=$(echo "$RELEASE_NOTES" | sed -n '/## ðŸ“‹ Changes/,$p' | sed '1d')
          
          # Create new changelog entry
          NEW_ENTRY="## [$VERSION] - $DATE"$'\n'$'\n'"$CHANGES_SECTION"$'\n'
          
          # Insert after [Unreleased] section
          if grep -q "## \[Unreleased\]" CHANGELOG.md; then
            awk -v entry="$NEW_ENTRY" '
              /## \[Unreleased\]/ { 
                print; 
                getline; 
                print; 
                print entry; 
                next 
              } 
              { print }
            ' CHANGELOG.md.bak > CHANGELOG.md
          else
            # Prepend to file
            echo "$NEW_ENTRY" | cat - CHANGELOG.md > CHANGELOG.md.tmp && mv CHANGELOG.md.tmp CHANGELOG.md
          fi
          
          # Update [Unreleased] link
          REPO_URL="https://github.com/${{ github.repository }}"
          sed -i.bak "s|\[Unreleased\]: .*|\[Unreleased\]: $REPO_URL/compare/$TAG_NAME...HEAD|" CHANGELOG.md
          
          # Add new version link
          PREV_TAG="${{ steps.previous-tag.outputs.previous_tag }}"
          if [ -n "$PREV_TAG" ] && [[ "$PREV_TAG" =~ ^v ]]; then
            NEW_LINE="[$VERSION]: $REPO_URL/compare/$PREV_TAG...$TAG_NAME"
            awk -v line="$NEW_LINE" '/\[Unreleased\]:/ {print; print line; next} {print}' CHANGELOG.md > CHANGELOG.md.tmp && mv CHANGELOG.md.tmp CHANGELOG.md
          fi
          
          rm -f CHANGELOG.md.bak
          
          echo "âœ… CHANGELOG.md updated"
          git diff CHANGELOG.md || true

      - name: ðŸ“¤ Commit CHANGELOG.md Update
        if: success()
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          if git diff --quiet CHANGELOG.md; then
            echo "â„¹ï¸  No changes to CHANGELOG.md"
          else
            git add CHANGELOG.md
            git commit -m "docs: update CHANGELOG.md for ${{ steps.previous-tag.outputs.current_tag }}"
            git push origin main || echo "âš ï¸  Failed to push CHANGELOG (may require manual update)"
          fi
        continue-on-error: true

      - name: ðŸš€ Create GitHub Release
        if: success()
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.previous-tag.outputs.current_tag }}
          name: Release ${{ steps.previous-tag.outputs.current_tag }}
          body: |
            ${{ steps.release-notes.outputs.release_notes }}
            
            ---
            
            ## ðŸ“¦ Artifacts
            
            - Android AAB/APK: Available in [GitHub Actions artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - iOS IPA: Available in [GitHub Actions artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - Web Build: Available in [GitHub Actions artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
          draft: false
          prerelease: false
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================================================
  # STAGE 8: Monitoring & Notifications
  # ============================================================================
  
  send-notifications:
    name: ðŸ“Š Send Deployment Notifications
    runs-on: ubuntu-latest
    needs: [production-release-summary, generate-release-notes]
    if: always()
    continue-on-error: true
    
    steps:
      - name: ðŸ“Š Determine Deployment Status
        id: status
        run: |
          SUMMARY_RESULT="${{ needs.production-release-summary.result }}"
          
          if [ "$SUMMARY_RESULT" == "success" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "emoji=âœ…" >> $GITHUB_OUTPUT
            echo "message=Production release successful" >> $GITHUB_OUTPUT
          elif [ "$SUMMARY_RESULT" == "failure" ]; then
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "emoji=âŒ" >> $GITHUB_OUTPUT
            echo "message=Production release failed" >> $GITHUB_OUTPUT
          elif [ "$SUMMARY_RESULT" == "cancelled" ]; then
            echo "status=cancelled" >> $GITHUB_OUTPUT
            echo "emoji=âš ï¸" >> $GITHUB_OUTPUT
            echo "message=Production release cancelled" >> $GITHUB_OUTPUT
          else
            echo "status=unknown" >> $GITHUB_OUTPUT
            echo "emoji=â“" >> $GITHUB_OUTPUT
            echo "message=Production release status unknown" >> $GITHUB_OUTPUT
          fi

      - name: ðŸ“§ Send Slack Notification
        if: env.SLACK_WEBHOOK_URL != ''
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          STATUS="${{ steps.status.outputs.status }}"
          EMOJI="${{ steps.status.outputs.emoji }}"
          MESSAGE="${{ steps.status.outputs.message }}"
          VERSION="${{ github.ref_name }}"
          ACTOR="${{ github.actor }}"
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          PAYLOAD=$(cat <<EOF
          {
            "text": "$EMOJI Production Release: $VERSION",
            "blocks": [
              {
                "type": "header",
                "text": {
                  "type": "plain_text",
                  "text": "$EMOJI Production Release: $VERSION"
                }
              },
              {
                "type": "section",
                "fields": [
                  {
                    "type": "mrkdwn",
                    "text": "*Status:*\n$MESSAGE"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Triggered by:*\n$ACTOR"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Version:*\n$VERSION"
                  },
                  {
                    "type": "mrkdwn",
                    "text": "*Workflow:*\n<${RUN_URL}|View Details>"
                  }
                ]
              }
            ]
          }
          EOF
          )
          
          curl -X POST -H 'Content-type: application/json' \
            --data "$PAYLOAD" \
            "$SLACK_WEBHOOK_URL" || echo "âš ï¸  Slack notification failed"
        continue-on-error: true

      - name: ðŸ“§ Send Discord Notification
        if: env.DISCORD_WEBHOOK_URL != ''
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
        run: |
          STATUS="${{ steps.status.outputs.status }}"
          EMOJI="${{ steps.status.outputs.emoji }}"
          MESSAGE="${{ steps.status.outputs.message }}"
          VERSION="${{ github.ref_name }}"
          ACTOR="${{ github.actor }}"
          RUN_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          # Discord color based on status
          if [ "$STATUS" == "success" ]; then
            COLOR=3066993  # Green
          elif [ "$STATUS" == "failure" ]; then
            COLOR=15158332  # Red
          else
            COLOR=16776960  # Yellow
          fi
          
          PAYLOAD=$(cat <<EOF
          {
            "embeds": [{
              "title": "$EMOJI Production Release: $VERSION",
              "description": "$MESSAGE",
              "color": $COLOR,
              "fields": [
                {
                  "name": "Version",
                  "value": "$VERSION",
                  "inline": true
                },
                {
                  "name": "Triggered by",
                  "value": "$ACTOR",
                  "inline": true
                },
                {
                  "name": "Workflow",
                  "value": "[View Details]($RUN_URL)",
                  "inline": false
                }
              ],
              "timestamp": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
            }]
          }
          EOF
          )
          
          curl -X POST -H 'Content-type: application/json' \
            --data "$PAYLOAD" \
            "$DISCORD_WEBHOOK_URL" || echo "âš ï¸  Discord notification failed"
        continue-on-error: true

      - name: âœ… Notification Summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ðŸ“Š NOTIFICATION STATUS"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Status: ${{ steps.status.outputs.emoji }} ${{ steps.status.outputs.message }}"
          echo "Version: ${{ github.ref_name }}"
          echo ""
          if [ -n "${{ secrets.SLACK_WEBHOOK_URL }}" ]; then
            echo "âœ… Slack webhook configured"
          else
            echo "â„¹ï¸  Slack webhook not configured (optional)"
          fi
          if [ -n "${{ secrets.DISCORD_WEBHOOK_URL }}" ]; then
            echo "âœ… Discord webhook configured"
          else
            echo "â„¹ï¸  Discord webhook not configured (optional)"
          fi
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

