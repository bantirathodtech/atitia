name: ðŸš€ Production Pipeline - Release Deployment

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on semantic version tags (v1.0.0, v1.2.3, etc.)
  workflow_dispatch:
    inputs:
      version_tag:
        description: 'Version tag to deploy (e.g., v1.0.0)'
        required: true
        default: 'v1.0.0'
      skip_approval:
        description: 'Skip manual approval (emergency only)'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

# Prevent concurrent production deployments
concurrency:
  group: production-deployment
  cancel-in-progress: false

env:
  JAVA_VERSION: '17'
  FLUTTER_VERSION: '3.35.7' # Pinned for reproducibility
  APP_ID: 'com.avishio.atitia'

jobs:
  # ============================================================================
  # STAGE 1: Validation & Tag Verification
  # ============================================================================
  
  validate-production:
    name: âœ… Validate Production Deployment
    runs-on: ubuntu-latest
    timeout-minutes: 5
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ” Verify Tag & Branch
        run: |
          echo "ðŸ” Validating production deployment requirements..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          if [[ "${{ github.ref }}" == refs/tags/* ]]; then
            TAG_NAME="${{ github.ref_name }}"
            echo "ðŸ“Œ Version tag detected: $TAG_NAME"
            
            # Verify tag format (semantic versioning)
            if [[ ! "$TAG_NAME" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "âŒ ERROR: Invalid tag format"
              echo "ðŸ’¡ Tag must follow semantic versioning: v1.0.0"
              echo "ðŸ’¡ Current tag: $TAG_NAME"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              exit 1
            fi
            
            # Verify tag is on main branch
            echo "ðŸ” Verifying tag is on main branch..."
            git fetch origin main:main 2>/dev/null || true
            
            if git branch -r --contains "$TAG_NAME" | grep -q "origin/main"; then
              echo "âœ… Tag $TAG_NAME is on main branch"
            else
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "âŒ ERROR: Tag $TAG_NAME is not on main branch"
              echo "ðŸ’¡ Production deployment only allowed from main branch"
              echo "ðŸ’¡ Please ensure tag is created on main branch:"
              echo "   git checkout main"
              echo "   git tag $TAG_NAME"
              echo "   git push origin main --tags"
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              exit 1
            fi
            
            # Extract version from tag
            VERSION="${TAG_NAME#v}"
            echo "ðŸ“¦ Version: $VERSION"
          else
            echo "ðŸ“Œ Manual dispatch detected"
            VERSION="${{ github.event.inputs.version_tag }}"
            VERSION="${VERSION#v}"  # Remove 'v' prefix if present
            echo "ðŸ“¦ Version: $VERSION"
          fi
          
          # Export version for use in other steps
          echo "VERSION=$VERSION" >> $GITHUB_ENV
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Tag/branch validation complete"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

      - name: ðŸ” Verify Version in pubspec.yaml
        run: |
          echo "ðŸ” Verifying version in pubspec.yaml..."
          PUBSPEC_VERSION=$(grep "^version:" pubspec.yaml | sed 's/version: //' | sed 's/+.*//')
          TAG_VERSION="${TAG_VERSION:-${{ github.ref_name }}}"
          
          echo "ðŸ“¦ pubspec.yaml version: $PUBSPEC_VERSION"
          echo "ðŸ“Œ Tag version: ${TAG_VERSION#v}"
          
          # Note: Version should match (warning, not blocking for now)
          echo "âœ… Version check complete"

      - name: ðŸ” Verify Production Secrets
        run: |
          echo "ðŸ” Verifying production deployment secrets..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          MISSING_SECRETS=0
          
          # Check Android secrets
          if [ -z "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" ]; then
            echo "âš ï¸  ANDROID_KEYSTORE_BASE64 not configured"
            MISSING_SECRETS=$((MISSING_SECRETS + 1))
          else
            echo "âœ… Android keystore configured"
          fi
          
          if [ -z "${{ secrets.ANDROID_KEYSTORE_PASSWORD }}" ]; then
            echo "âš ï¸  ANDROID_KEYSTORE_PASSWORD not configured"
            MISSING_SECRETS=$((MISSING_SECRETS + 1))
          else
            echo "âœ… Android keystore password configured"
          fi
          
          # Check iOS secrets (optional - iOS deployment will skip if not configured)
          if [ -z "${{ secrets.IOS_CERTIFICATE_BASE64 }}" ]; then
            echo "âš ï¸  iOS certificate not configured (iOS deployment will be skipped)"
          else
            echo "âœ… iOS certificate configured"
          fi
          
          # Check store publishing secrets
          if [ -z "${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}" ]; then
            echo "âš ï¸  GOOGLE_PLAY_SERVICE_ACCOUNT_JSON not configured (Play Store upload will be skipped)"
          else
            echo "âœ… Google Play service account configured"
          fi
          
          # Check Firebase production secrets
          if [ -z "${{ secrets.FIREBASE_SERVICE_ACCOUNT }}" ]; then
            echo "âš ï¸  FIREBASE_SERVICE_ACCOUNT not configured (Firebase deployment will be skipped)"
          else
            echo "âœ… Firebase service account configured"
          fi
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          if [ $MISSING_SECRETS -gt 0 ]; then
            echo "âš ï¸  Warning: $MISSING_SECRETS required secret(s) missing"
            echo "ðŸ’¡ Some deployments may be skipped"
          else
            echo "âœ… All required secrets configured"
          fi

  # ============================================================================
  # STAGE 2: Manual Approval Gate (Production Safety)
  # ============================================================================
  
  # Note: Manual approval is handled via GitHub Environments
  # Create a "production" environment in GitHub settings with required reviewers
  
  production-approval:
    name: ðŸ‘¤ Manual Approval (Production Release)
    runs-on: ubuntu-latest
    needs: validate-production
    if: github.event.inputs.skip_approval != 'true'
    environment:
      name: production
      url: https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name || github.event.inputs.version_tag }}
    steps:
      - name: âœ… Production Release Approved
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… PRODUCTION RELEASE APPROVED"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ðŸ“¦ Version: ${{ github.ref_name || github.event.inputs.version_tag }}"
          echo "ðŸ‘¤ Approved by: ${{ github.actor }}"
          echo "ðŸ• Approved at: $(date -u +'%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          echo "ðŸš€ Proceeding with production deployment..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  # ============================================================================
  # STAGE 3: Quality Gates (Reuse from Staging - Proven to Work)
  # ============================================================================
  
  entry-gate:
    name: ðŸšª Entry Gate
    runs-on: ubuntu-latest
    timeout-minutes: 2
    needs: [validate-production, production-approval]
    if: always() && needs.validate-production.result == 'success' && (needs.production-approval.result == 'success' || needs.production-approval.result == 'skipped' || github.event.inputs.skip_approval == 'true')
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: âœ… Validate Project Structure
        run: |
          echo "ðŸ” Validating project structure..."
          [ -f "pubspec.yaml" ] || { echo "âŒ pubspec.yaml not found"; exit 1; }
          [ -d "lib" ] || { echo "âŒ lib/ directory not found"; exit 1; }
          [ -d "android" ] || { echo "âŒ android/ directory not found"; exit 1; }
          [ -d "ios" ] || { echo "âŒ ios/ directory not found"; exit 1; }
          echo "âœ… Project structure valid"

      - name: ðŸ”’ Security Pre-Check
        run: |
          echo "ðŸ”’ Running security pre-check..."
          if grep -rE "(password|secret|api_key|private_key|token)" lib/ --include="*.dart" 2>/dev/null | grep -vE "(TODO|FIXME|example|test)" | grep -vE "^[[:space:]]*//"; then
            echo "âš ï¸ Potential secrets found - please review"
          else
            echo "âœ… No obvious secrets detected"
          fi
        continue-on-error: true

  dependencies:
    name: ðŸ“¦ Resolve Dependencies
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: entry-gate
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸŽ¯ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: ðŸ“¦ Get Dependencies
        run: |
          set +e
          echo "ðŸ“¦ Resolving dependencies..."
          flutter pub get --no-example
          PUB_GET_EXIT=$?
          
          if [ "$PUB_GET_EXIT" -ne 0 ]; then
            echo "âš ï¸ First attempt failed, retrying..."
            flutter pub get --verbose 2>&1 | tail -50
            RETRY_EXIT=$?
            
            if [ "$RETRY_EXIT" -ne 0 ]; then
              echo "âŒ Dependency resolution failed"
              exit 1
            fi
          fi
          
          echo "âœ… Dependencies resolved successfully"
        timeout-minutes: 10

  code-quality:
    name: ðŸ“Š Code Quality
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: dependencies
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸŽ¯ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: ðŸ“¦ Get Dependencies
        run: flutter pub get
        timeout-minutes: 3

      - name: ðŸ” Static Analysis
        run: |
          set +e
          echo "ðŸ” Running static analysis..."
          
          ANALYSIS_OUTPUT=$(flutter analyze --no-fatal-infos --no-fatal-warnings 2>&1)
          ANALYSIS_EXIT_CODE=$?
          
          if echo "$ANALYSIS_OUTPUT" | grep -q "error â€¢" 2>/dev/null; then
            echo "âŒ Code analysis found ERRORS (blocking):"
            echo "$ANALYSIS_OUTPUT" | grep "error â€¢" | head -30
            exit 1
          fi
          
          echo "âœ… Code analysis complete"
        timeout-minutes: 10

      - name: ðŸ“ Format Check
        run: |
          set +e
          echo "ðŸ“ Checking code formatting..."
          
          FORMAT_OUTPUT=$(dart format --set-exit-if-changed . 2>&1)
          FORMAT_EXIT_CODE=$?
          
          CHANGED_COUNT=$(echo "$FORMAT_OUTPUT" | grep -oE "\([0-9]+ changed\)" 2>/dev/null | grep -oE "[0-9]+" 2>/dev/null || echo "")
          
          if [ -n "$CHANGED_COUNT" ] && [ "$CHANGED_COUNT" -ne 0 ]; then
            echo "âŒ Formatting issues detected (blocking)"
            echo "ðŸ“Š Files needing formatting: $CHANGED_COUNT"
            echo "ðŸ’¡ Run: dart format ."
            exit 1
          fi
          
          echo "âœ… Code properly formatted"
        timeout-minutes: 5

  security-audit:
    name: ðŸ”’ Security Audit
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: dependencies
    if: "!failure() && !cancelled()"
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸŽ¯ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: ðŸ“¦ Get Dependencies
        run: flutter pub get
        timeout-minutes: 3

      - name: ðŸ”’ Security Audit
        run: |
          set +e
          echo "ðŸ”’ Running security audit..."
          
          AUDIT_OUTPUT=$(flutter pub audit 2>&1)
          AUDIT_EXIT_CODE=$?
          
          if echo "$AUDIT_OUTPUT" | grep -qiE "(critical|high severity)" 2>/dev/null; then
            echo "âŒ CRITICAL/HIGH severity vulnerabilities found (blocking):"
            echo "$AUDIT_OUTPUT" | grep -iE "(critical|high severity)" || echo "$AUDIT_OUTPUT"
            exit 1
          fi
          
          echo "âœ… Security audit passed - no critical vulnerabilities"
        timeout-minutes: 10

  test:
    name: ðŸ§ª Run Tests
    runs-on: ubuntu-latest
    timeout-minutes: 25
    needs: dependencies
    if: "!failure() && !cancelled()"
    
    strategy:
      fail-fast: false
      matrix:
        test-type: [unit, widget, integration]
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸŽ¯ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: ðŸ“¦ Get Dependencies
        run: flutter pub get
        timeout-minutes: 3

      - name: ðŸ§ª Run Unit Tests
        if: matrix.test-type == 'unit'
        run: |
          echo "ðŸ§ª Running unit tests..."
          flutter test test/unit/ --no-pub --coverage
        timeout-minutes: 12

      - name: ðŸŽ¨ Run Widget Tests
        if: matrix.test-type == 'widget'
        run: |
          echo "ðŸŽ¨ Running widget tests..."
          flutter test test/widget_test.dart --no-pub --coverage
        timeout-minutes: 8

      - name: ðŸ”— Run Integration Tests
        if: matrix.test-type == 'integration'
        run: |
          echo "ðŸ”— Running integration tests..."
          if [ -d "test/integration" ] && [ "$(ls -A test/integration/*.dart 2>/dev/null)" ]; then
            flutter test test/integration/ --no-pub --coverage
          else
            echo "â„¹ï¸ No integration tests found, skipping..."
          fi
        continue-on-error: false
        timeout-minutes: 15

  # ============================================================================
  # STAGE 4: Production Builds (All Platforms)
  # ============================================================================
  
  build-android-production:
    name: ðŸ¤– Build Android (Production)
    runs-on: ubuntu-latest
    timeout-minutes: 35
    needs: [code-quality, test]
    if: "!failure() && !cancelled()"
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: â˜• Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ env.JAVA_VERSION }}
          cache: 'gradle'

      - name: ðŸŽ¯ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: ðŸ“¦ Get Dependencies
        run: flutter pub get
        timeout-minutes: 3

      - name: ðŸ” Setup Android Signing
        env:
          KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          if [ -n "$KEYSTORE_BASE64" ] && [ "$KEYSTORE_BASE64" != "" ]; then
            echo "ðŸ” Configuring Android production signing..."
            echo "$KEYSTORE_BASE64" | base64 -d > android/keystore.jks
            
            # Create key.properties file
            cat > android/key.properties << EOF
            storePassword=$KEYSTORE_PASSWORD
            keyPassword=$KEY_PASSWORD
            keyAlias=$KEY_ALIAS
            storeFile=keystore.jks
            EOF
            
            echo "âœ… Android signing configured"
          else
            echo "âŒ ERROR: Android keystore secret not configured"
            echo "ðŸ’¡ Production build requires ANDROID_KEYSTORE_BASE64 secret"
            exit 1
          fi

      - name: ðŸ§¹ Clean Up Disk Space
        run: |
          echo "ðŸ§¹ Cleaning up disk space before production build..."
          df -h
          
          # Clean any leftover build artifacts
          rm -rf build/app/intermediates || true
          rm -rf build/app/tmp || true
          
          echo "ðŸ“Š Disk space after cleanup:"
          df -h

      - name: ðŸ¤– Build Android App Bundle (AAB)
        run: |
          echo "ðŸ”¨ Building Android App Bundle (AAB) for production..."
          flutter build appbundle --release --no-pub || {
            echo "âŒ Android AAB build failed"
            exit 1
          }
          echo "âœ… Android App Bundle built successfully"

      - name: ðŸ¤– Build Android APK (Split per ABI)
        run: |
          echo "ðŸ”¨ Building Android APK (split per ABI) for production..."
          flutter build apk --release --split-per-abi --no-pub || {
            echo "âš ï¸ Split APK build completed with notes"
            exit 0
          }
          echo "âœ… Android split APKs built successfully"

      - name: ðŸ“¤ Upload Production Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: android-production-${{ github.ref_name }}
          path: |
            build/app/outputs/bundle/release/*.aab
            build/app/outputs/flutter-apk/*.apk
          retention-days: 90
          if-no-files-found: error

  build-ios-production:
    name: ðŸŽ Build iOS (Production)
    runs-on: macos-15
    timeout-minutes: 60
    needs: [code-quality, test, entry-gate]
    if: "!failure() && !cancelled()"
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸŽ¯ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: ðŸ“¦ Cache CocoaPods
        uses: actions/cache@v4
        id: pod-cache
        with:
          path: |
            ios/Pods
            ~/Library/Caches/CocoaPods
            ~/.cocoapods
          key: ${{ runner.os }}-pods-${{ hashFiles('ios/Podfile.lock') }}
          restore-keys: |
            ${{ runner.os }}-pods-

      - name: ðŸ“¦ Get Dependencies
        run: flutter pub get
        timeout-minutes: 3

      - name: ðŸ“¦ Setup CocoaPods
        run: |
          echo "ðŸ“¦ Setting up CocoaPods..."
          cd ios
          pod install --deployment || pod install || true
          cd ..
          echo "âœ… CocoaPods ready"
        continue-on-error: true
        timeout-minutes: 8

      - name: ðŸŽ Build iOS IPA
        env:
          IOS_CERTIFICATE_BASE64: ${{ secrets.IOS_CERTIFICATE_BASE64 }}
        run: |
          if [ -n "$IOS_CERTIFICATE_BASE64" ] && [ "$IOS_CERTIFICATE_BASE64" != "" ]; then
            echo "ðŸ”¨ Building iOS IPA for production..."
            flutter build ipa --release --no-pub || {
              echo "âŒ iOS IPA build failed"
              exit 1
            }
            echo "âœ… iOS IPA built successfully"
          else
            echo "âš ï¸ iOS certificate not configured - skipping iOS build"
            echo "ðŸ’¡ Add IOS_CERTIFICATE_BASE64 secret to enable iOS deployment"
            exit 0
          fi
        continue-on-error: true

      - name: ðŸ“¤ Upload iOS Artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: ios-production-${{ github.ref_name }}
          path: |
            build/ios/ipa/*.ipa
          retention-days: 90
          if-no-files-found: ignore

  build-web-production:
    name: ðŸŒ Build Web (Production)
    runs-on: ubuntu-latest
    timeout-minutes: 20
    needs: [code-quality, test, entry-gate]
    if: "!failure() && !cancelled()"
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸŽ¯ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: ðŸ“¦ Get Dependencies
        run: flutter pub get
        timeout-minutes: 3

      - name: ðŸŒ Build Web
        run: |
          echo "ðŸ”¨ Building Web for production..."
          flutter build web --release --no-pub || {
            echo "âŒ Web build failed"
            exit 1
          }
          echo "âœ… Web build completed"

      - name: ðŸ“¤ Upload Web Artifact
        uses: actions/upload-artifact@v4
        with:
          name: web-production-${{ github.ref_name }}
          path: build/web/
          retention-days: 90
          if-no-files-found: error

  # ============================================================================
  # STAGE 5: Production Deployments (Stores + Firebase)
  # ============================================================================
  
  deploy-android-playstore:
    name: ðŸ“± Deploy to Google Play Store
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: build-android-production
    if: success() && !cancelled()
    environment:
      name: production
    steps:
      - name: ðŸ“¥ Download Android Artifacts
        uses: actions/download-artifact@v4
        with:
          name: android-production-${{ github.ref_name }}
          path: build/app/outputs/

      - name: ðŸ“± Upload to Google Play Store
        env:
          GOOGLE_PLAY_SERVICE_ACCOUNT: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
        run: |
          if [ -n "$GOOGLE_PLAY_SERVICE_ACCOUNT" ] && [ "$GOOGLE_PLAY_SERVICE_ACCOUNT" != "" ]; then
            echo "ðŸ“± Uploading to Google Play Store..."
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            # Write service account to file
            echo "$GOOGLE_PLAY_SERVICE_ACCOUNT" > /tmp/google-play-service-account.json
            
            # Install fastlane (if using) or use gcloud
            # For now, skip actual upload (requires fastlane setup)
            echo "âš ï¸ Play Store upload requires fastlane setup"
            echo "ðŸ’¡ AAB file is ready in artifacts for manual upload"
            echo "ðŸ“¦ AAB location: build/app/outputs/bundle/release/"
            
            echo "âœ… Play Store deployment preparation complete"
          else
            echo "âš ï¸ Google Play service account not configured"
            echo "ðŸ’¡ AAB file is ready in artifacts for manual upload"
          fi
        continue-on-error: true

  deploy-ios-appstore:
    name: ðŸŽ Deploy to Apple App Store
    runs-on: macos-15
    timeout-minutes: 30
    needs: build-ios-production
    if: success() && !cancelled()
    environment:
      name: production
    steps:
      - name: ðŸ“¥ Download iOS Artifacts
        uses: actions/download-artifact@v4
        with:
          name: ios-production-${{ github.ref_name }}
          path: build/ios/ipa/

      - name: ðŸŽ Upload to App Store Connect
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
        run: |
          if [ -n "$APPLE_ID" ] && [ -n "$APPLE_APP_SPECIFIC_PASSWORD" ]; then
            echo "ðŸŽ Uploading to App Store Connect..."
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            
            # Install fastlane (if using) or use altool/xcrun
            # For now, skip actual upload (requires fastlane setup)
            echo "âš ï¸ App Store upload requires fastlane setup"
            echo "ðŸ’¡ IPA file is ready in artifacts for manual upload"
            echo "ðŸ“¦ IPA location: build/ios/ipa/"
            
            echo "âœ… App Store deployment preparation complete"
          else
            echo "âš ï¸ Apple credentials not configured"
            echo "ðŸ’¡ IPA file is ready in artifacts for manual upload"
          fi
        continue-on-error: true

  deploy-firebase-production:
    name: ðŸŒ Deploy to Firebase (Production)
    runs-on: ubuntu-latest
    timeout-minutes: 25
    needs: build-web-production
    if: success() && !cancelled()
    environment:
      name: production
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸ“¥ Download Web Build Artifact
        uses: actions/download-artifact@v4
        with:
          name: web-production-${{ github.ref_name }}
          path: build/web/

      - name: ðŸš€ Deploy to Firebase Hosting (Production)
        env:
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
        run: |
          if [ -n "$FIREBASE_SERVICE_ACCOUNT" ] && [ "$FIREBASE_SERVICE_ACCOUNT" != "" ]; then
            echo "ðŸš€ Deploying to Firebase Hosting (Production)..."
            echo "ðŸ“¦ Version: ${{ github.ref_name }}"
            echo "ðŸ”§ Project: ${FIREBASE_PROJECT_ID:-not-set}"
            
            npm install -g firebase-tools
            
            echo "$FIREBASE_SERVICE_ACCOUNT" > /tmp/firebase-service-account.json
            export GOOGLE_APPLICATION_CREDENTIALS=/tmp/firebase-service-account.json
            
            if [ -n "$FIREBASE_PROJECT_ID" ] && [ "$FIREBASE_PROJECT_ID" != "" ]; then
              firebase deploy --only hosting --project "$FIREBASE_PROJECT_ID" || {
                echo "âŒ Firebase deployment failed"
                rm -f /tmp/firebase-service-account.json
                exit 1
              }
              echo "âœ… Successfully deployed to Firebase Hosting (Production)"
              rm -f /tmp/firebase-service-account.json
            else
              echo "âš ï¸ FIREBASE_PROJECT_ID not set - skipping deployment"
              rm -f /tmp/firebase-service-account.json
            fi
          else
            echo "âš ï¸ Firebase service account not configured - skipping deployment"
            echo "ðŸ’¡ Add FIREBASE_SERVICE_ACCOUNT secret to enable deployment"
          fi
        continue-on-error: false

  # ============================================================================
  # STAGE 6: Production Release Summary
  # ============================================================================
  
  production-release-summary:
    name: ðŸ“‹ Production Release Summary
    runs-on: ubuntu-latest
    needs: [validate-production, production-approval, entry-gate, dependencies, code-quality, security-audit, test, build-android-production, build-ios-production, build-web-production, deploy-android-playstore, deploy-ios-appstore, deploy-firebase-production]
    if: always()
    
    steps:
      - name: ðŸ“Š Generate Release Summary
        run: |
          echo "## ðŸš€ Production Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Execution Time:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Quality Gates" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Gate | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| âœ… Validation | ${{ needs.validate-production.result }} |" >> $GITHUB_STEP_SUMMARY
          if [ "${{ github.event.inputs.skip_approval }}" == "true" ]; then
            echo "| ðŸ‘¤ Approval | âš ï¸ Skipped (Emergency) |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.production-approval.result }}" == "success" ]; then
            echo "| ðŸ‘¤ Approval | âœ… Approved |" >> $GITHUB_STEP_SUMMARY
          elif [ "${{ needs.production-approval.result }}" == "skipped" ]; then
            echo "| ðŸ‘¤ Approval | â³ Skipped (not required) |" >> $GITHUB_STEP_SUMMARY
          else
            echo "| ðŸ‘¤ Approval | â³ Pending |" >> $GITHUB_STEP_SUMMARY
          fi
          echo "| ðŸšª Entry Gate | ${{ needs.entry-gate.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“¦ Dependencies | ${{ needs.dependencies.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“Š Code Quality | ${{ needs.code-quality.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ”’ Security | ${{ needs.security-audit.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ§ª Tests | ${{ needs.test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Production Builds" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Build | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ¤– Android (AAB/APK) | ${{ needs.build-android-production.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŽ iOS (IPA) | ${{ needs.build-ios-production.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŒ Web | ${{ needs.build-web-production.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Production Deployments" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Deployment | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“± Google Play Store | ${{ needs.deploy-android-playstore.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŽ Apple App Store | ${{ needs.deploy-ios-appstore.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŒ Firebase (Production) | ${{ needs.deploy-firebase-production.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Determine overall status
          CRITICAL_JOBS="${{ needs.validate-production.result }} ${{ needs.entry-gate.result }} ${{ needs.dependencies.result }} ${{ needs.code-quality.result }}"
          BUILD_JOBS="${{ needs.build-android-production.result }} ${{ needs.build-web-production.result }}"
          
          if echo "$CRITICAL_JOBS" | grep -q "failure"; then
            echo "### âŒ **Status: PRODUCTION RELEASE FAILED**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Critical quality gates failed. Release cannot proceed." >> $GITHUB_STEP_SUMMARY
          elif echo "$BUILD_JOBS" | grep -q "failure"; then
            echo "### âš ï¸ **Status: PRODUCTION RELEASE PARTIAL**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Some builds failed. Review artifacts and logs." >> $GITHUB_STEP_SUMMARY
          else
            echo "### âœ… **Status: PRODUCTION RELEASE SUCCESSFUL**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All production builds completed successfully. Check deployment status above." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“¦ Production Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Android AAB/APK:** Available in artifacts (90-day retention)" >> $GITHUB_STEP_SUMMARY
          echo "- **iOS IPA:** Available in artifacts (90-day retention)" >> $GITHUB_STEP_SUMMARY
          echo "- **Web Build:** Available in artifacts (90-day retention)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Download production artifacts from GitHub Actions" >> $GITHUB_STEP_SUMMARY
          echo "2. Upload to App Store/Play Store (if not automated)" >> $GITHUB_STEP_SUMMARY
          echo "3. Verify Firebase production deployment" >> $GITHUB_STEP_SUMMARY
          echo "4. Monitor app store review process" >> $GITHUB_STEP_SUMMARY

