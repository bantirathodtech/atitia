name: âš¡ Dev Pipeline - Fast Feedback

on:
  push:
    branches: [dev] # Fast feedback on dev branch
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'docs/**'
      - '*.md'
      - 'README*.md'
  pull_request:
    branches: [dev] # PRs to dev also get fast feedback
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'docs/**'

# Cancel previous runs when new push happens (fast feedback)
concurrency:
  group: dev-pipeline-${{ github.ref }}
  cancel-in-progress: true

env:
  FLUTTER_VERSION: '3.35.7' # Pinned for reproducibility

jobs:
  # ============================================================================
  # STAGE 1: Fast Validation (Parallel Execution for Speed)
  # ============================================================================
  
  quick-structure-check:
    name: âœ… Quick Structure Check
    runs-on: ubuntu-latest
    timeout-minutes: 1
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ðŸ” Validate Essential Files
        run: |
          echo "ðŸ” Quick structure validation..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          # Check critical files exist
          [ -f "pubspec.yaml" ] || { echo "âŒ pubspec.yaml not found"; exit 1; }
          [ -d "lib" ] || { echo "âŒ lib/ directory not found"; exit 1; }
          
          echo "âœ… Essential structure valid"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  dependency-check:
    name: ðŸ“¦ Dependency Check
    runs-on: ubuntu-latest
    timeout-minutes: 3
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸŽ¯ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: ðŸ“¦ Get Dependencies
        run: |
          echo "ðŸ“¦ Checking dependencies..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          flutter pub get --no-example || {
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âŒ Dependency resolution failed"
            echo "ðŸ’¡ Check pubspec.yaml for issues"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            exit 1
          }
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Dependencies resolved"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  format-check:
    name: ðŸ“ Format Check
    runs-on: ubuntu-latest
    timeout-minutes: 2
    needs: dependency-check
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸŽ¯ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: ðŸ“¦ Get Dependencies
        run: flutter pub get
        timeout-minutes: 2

      - name: ðŸ“ Check Formatting
        run: |
          set +e # Disable exit on error temporarily
          
          echo "ðŸ“ Checking code formatting..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          FORMAT_OUTPUT=$(dart format --set-exit-if-changed . 2>&1)
          FORMAT_EXIT_CODE=$?
          
          # Extract changed count
          CHANGED_COUNT=$(echo "$FORMAT_OUTPUT" | grep -oE "\([0-9]+ changed\)" 2>/dev/null | grep -oE "[0-9]+" 2>/dev/null || echo "")
          
          if [ -n "$CHANGED_COUNT" ]; then
            if [ "$CHANGED_COUNT" -eq 0 ]; then
              echo "âœ… Code properly formatted (0 files changed)"
              exit 0
            else
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              echo "âš ï¸ Formatting issues found: $CHANGED_COUNT files"
              echo "ðŸ’¡ Run: dart format ."
              echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
              # Non-blocking for dev - just warn
              exit 0
            fi
          elif [ "$FORMAT_EXIT_CODE" -eq 0 ]; then
            echo "âœ… Code properly formatted"
            exit 0
          else
            echo "âš ï¸ Format check completed with notes"
            exit 0
          fi

  quick-analysis:
    name: ðŸ” Quick Analysis (Errors Only)
    runs-on: ubuntu-latest
    timeout-minutes: 3
    needs: dependency-check
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸŽ¯ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: ðŸ“¦ Get Dependencies
        run: flutter pub get
        timeout-minutes: 2

      - name: ðŸ” Analyze Code (Errors Only)
        run: |
          set +e # Disable exit on error temporarily
          
          echo "ðŸ” Running quick analysis (errors only)..."
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          
          ANALYSIS_OUTPUT=$(flutter analyze --no-fatal-infos --no-fatal-warnings 2>&1)
          ANALYSIS_EXIT_CODE=$?
          
          # Check for errors (blocking)
          if echo "$ANALYSIS_OUTPUT" | grep -q "error â€¢" 2>/dev/null; then
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "âŒ Analysis found ERRORS (blocking):"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            echo "$ANALYSIS_OUTPUT" | grep "error â€¢" | head -20
            echo ""
            echo "ðŸ’¡ Fix errors before proceeding"
            echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
            exit 1
          fi
          
          # Warnings are non-blocking (just log them)
          if echo "$ANALYSIS_OUTPUT" | grep -q "warning â€¢" 2>/dev/null; then
            WARNING_COUNT=$(echo "$ANALYSIS_OUTPUT" | grep -c "warning â€¢" || echo "0")
            echo "âš ï¸ Found $WARNING_COUNT warnings (non-blocking)"
            echo "$ANALYSIS_OUTPUT" | grep "warning â€¢" | head -10 || true
          fi
          
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… Quick analysis complete (no blocking errors)"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  # ============================================================================
  # STAGE 2: Summary (Always Runs)
  # ============================================================================
  
  dev-summary:
    name: ðŸ“‹ Dev Pipeline Summary
    runs-on: ubuntu-latest
    needs: [quick-structure-check, dependency-check, format-check, quick-analysis]
    if: always()
    
    steps:
      - name: ðŸ“Š Generate Summary
        run: |
          echo "## âš¡ Dev Pipeline - Fast Feedback Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Execution Time:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "### Quick Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Check | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| âœ… Structure | ${{ needs.quick-structure-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“¦ Dependencies | ${{ needs.dependency-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“ Format | ${{ needs.format-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ” Analysis | ${{ needs.quick-analysis.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Determine overall status
          if [ "${{ needs.quick-structure-check.result }}" == "success" ] && \
             [ "${{ needs.dependency-check.result }}" == "success" ] && \
             [ "${{ needs.quick-analysis.result }}" == "success" ]; then
            echo "### âœ… **Status: READY FOR STAGING**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "All essential checks passed. Code is ready to merge to staging for comprehensive testing." >> $GITHUB_STEP_SUMMARY
          else
            echo "### âš ï¸ **Status: NEEDS ATTENTION**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Some checks failed. Please review and fix issues before merging to staging." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ’¡ Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Fix any errors found above" >> $GITHUB_STEP_SUMMARY
          echo "- Format code if needed: \`dart format .\`" >> $GITHUB_STEP_SUMMARY
          echo "- Merge to \`staging\` for comprehensive testing" >> $GITHUB_STEP_SUMMARY

