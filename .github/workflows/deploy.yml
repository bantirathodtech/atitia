name: Deploy to Stores

on:
  push:
    tags:
      - 'v*.*.*'  # Triggers on version tags like v1.0.0
  workflow_dispatch:  # Allows manual trigger
  # NOTE: This workflow does NOT run on regular commits
  # Only runs when you push a version tag: git tag v1.0.0 && git push origin v1.0.0

jobs:
  # Deploy to Google Play Store (Internal Testing)
  deploy-android:
    name: Deploy Android to Play Store
    runs-on: ubuntu-latest
    # environment: production  # Uncomment when production environment is configured in GitHub
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true
      
      - name: Install Dependencies
        run: flutter pub get
      
      - name: Decode Signing Key
        env:
          KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
          KEYSTORE_PASSWORD: ${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.ANDROID_KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        run: |
          echo "$KEYSTORE_BASE64" | base64 -d > android/keystore.jks
          cat > android/key.properties << EOF
          storeFile=keystore.jks
          storePassword=$KEYSTORE_PASSWORD
          keyAlias=$KEY_ALIAS
          keyPassword=$KEY_PASSWORD
          EOF
        if: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
      
      - name: Build App Bundle
        run: flutter build appbundle --release
      
      - name: Upload to Play Store
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
          packageName: com.avishio.atitia
          releaseFiles: build/app/outputs/bundle/release/app-release.aab
          track: internal  # internal | alpha | beta | production
        if: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}

  # Deploy to App Store Connect (TestFlight)
  deploy-ios:
    name: Deploy iOS to App Store
    runs-on: macos-latest
    # environment: production  # Uncomment when production environment is configured in GitHub
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true
      
      - name: Install Dependencies
        run: flutter pub get
      
      - name: Setup CocoaPods
        run: |
          cd ios
          pod install
      
      - name: Build iOS Archive
        run: |
          flutter build ipa --release
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_SPECIFIC_PASSWORD: ${{ secrets.APPLE_APP_SPECIFIC_PASSWORD }}
          CERTIFICATE_BASE64: ${{ secrets.IOS_CERTIFICATE_BASE64 }}
          CERTIFICATE_PASSWORD: ${{ secrets.IOS_CERTIFICATE_PASSWORD }}
          PROVISIONING_PROFILE_BASE64: ${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}
      
      - name: Upload to App Store Connect
        uses: apple-actions/upload-testflight-build@v1
        with:
          app-path: build/ios/ipa/*.ipa
          api-key-id: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          api-issuer: ${{ secrets.APP_STORE_CONNECT_API_ISSUER }}
          api-key: ${{ secrets.APP_STORE_CONNECT_API_KEY }}
        if: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}

  # Deploy Web to Firebase Hosting
  deploy-web:
    name: Deploy Web to Firebase
    runs-on: ubuntu-latest
    # environment: production  # Uncomment when production environment is configured in GitHub
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true
      
      - name: Install Dependencies
        run: flutter pub get
      
      - name: Build Web
        run: flutter build web --release
      
      - name: Setup Firebase CLI
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: '${{ secrets.GITHUB_TOKEN }}'
          firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}'
          channelId: live
          projectId: ${{ secrets.FIREBASE_PROJECT_ID }}
        if: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}

