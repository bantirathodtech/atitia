name: ðŸš€ Firebase Deployment - Staging Only

on:
  push:
    branches: [staging]  # Deploy to Firebase only on staging branch
    paths-ignore:
      - '**.md'
      - '.gitignore'
      - 'docs/**'
      - '*.md'
      - 'README*.md'
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "deploy" to confirm Firebase deployment'
        required: true
        default: 'deploy'

# Prevent concurrent deployments for same branch
concurrency:
  group: firebase-deploy-${{ github.ref }}
  cancel-in-progress: false

env:
  FLUTTER_VERSION: '3.35.7'  # Pinned for reproducibility

jobs:
  # ============================================================================
  # WEB: Deploy to Firebase Hosting
  # ============================================================================
  deploy-firebase-web:
    name: ðŸŒ Deploy Web to Firebase
    runs-on: ubuntu-latest
    timeout-minutes: 25
    
    steps:
      - name: ðŸ“¥ Checkout Code
        uses: actions/checkout@v4

      - name: ðŸŽ¯ Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: stable
          cache: true

      - name: ðŸ“¦ Get Dependencies
        run: flutter pub get
        timeout-minutes: 3

      - name: ðŸŒ Build Web
        run: |
          echo "ðŸ”¨ Building Web for Firebase deployment..."
          echo "ðŸ“¦ Branch: ${{ github.ref_name }}"
          flutter build web --release --no-pub
          echo "âœ… Web build completed"

      - name: ðŸ“¤ Upload Web Artifact
        uses: actions/upload-artifact@v4
        with:
          name: web-firebase-${{ github.ref_name }}
          path: build/web/
          retention-days: 7
          if-no-files-found: ignore

      - name: ðŸš€ Deploy to Firebase Hosting
        env:
          FIREBASE_SERVICE_ACCOUNT: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
        run: |
          if [ -n "$FIREBASE_SERVICE_ACCOUNT" ] && [ "$FIREBASE_SERVICE_ACCOUNT" != "" ]; then
            echo "ðŸš€ Deploying to Firebase Hosting..."
            echo "ðŸ“¦ Branch: ${{ github.ref_name }}"
            echo "ðŸ”§ Project: ${FIREBASE_PROJECT_ID:-not-set}"
            
            # Setup Firebase CLI
            npm install -g firebase-tools
            
            # Authenticate with service account
            echo "$FIREBASE_SERVICE_ACCOUNT" > /tmp/firebase-service-account.json
            export GOOGLE_APPLICATION_CREDENTIALS=/tmp/firebase-service-account.json
            
            # Deploy to Firebase Hosting
            if [ -n "$FIREBASE_PROJECT_ID" ] && [ "$FIREBASE_PROJECT_ID" != "" ]; then
              firebase deploy --only hosting --project "$FIREBASE_PROJECT_ID" || {
                echo "âš ï¸ Firebase deployment failed"
                exit 1
              }
              echo "âœ… Successfully deployed to Firebase Hosting"
            else
              echo "âš ï¸ FIREBASE_PROJECT_ID not set - skipping deployment"
              echo "ðŸ’¡ Add FIREBASE_PROJECT_ID secret to enable deployment"
            fi
          else
            echo "âš ï¸ Firebase service account not configured - skipping deployment"
            echo "ðŸ’¡ Add FIREBASE_SERVICE_ACCOUNT secret to enable deployment"
          fi
        continue-on-error: true

  # ============================================================================
  # DEPLOYMENT SUMMARY
  # ============================================================================
  deployment-summary:
    name: ðŸ“‹ Firebase Deployment Summary
    runs-on: ubuntu-latest
    needs: [deploy-firebase-web]
    if: always()
    
    steps:
      - name: ðŸ“Š Generate Summary
        run: |
          echo "## ðŸš€ Firebase Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed At:** $(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Deployment Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Platform | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŒ Web (Firebase) | ${{ needs.deploy-firebase-web.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.deploy-firebase-web.result }}" == "success" ]; then
            echo "âœ… Firebase deployment completed successfully!" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Firebase deployment completed with warnings. Check logs for details." >> $GITHUB_STEP_SUMMARY
          fi

